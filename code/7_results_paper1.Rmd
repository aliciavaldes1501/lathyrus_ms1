---
title: "Results Lathyrus paper 1"
output:
  pdf_document:
    toc: yes
    toc_depth: 4
editor_options:
  chunk_output_type: inline
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r Read data created with previous scripts, include=FALSE}
alldata<-read.csv(
  "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/alldata.csv",
                       header=T,sep="\t",dec=".") #Read field data
temperature<-read.table(
  "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/temperature.csv",
                        header=T,sep="\t",dec=".") 
precipitation<-read.table(
  "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/precipitation.csv",
                          header=T,sep="\t",dec=".")
precipitation_extra<-read.table(
  "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/precipitation_extra.csv",
                          header=T,sep="\t",dec=".")
dates<-read.table(
  "C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/dates.csv",
                        header=T,sep="\t",dec=".") 
temperature$date<-as.Date(as.character(temperature$date))
precipitation$date<-as.Date(as.character(precipitation$date))
precipitation$precipitation<-as.numeric(as.character(precipitation$precipitation))
precipitation$year<-as.integer(as.character(precipitation$year))
precipitation$month<-as.integer(as.character(precipitation$month))
precipitation$day<-as.integer(as.character(precipitation$day))
precipitation<-subset(precipitation,year>1960) # Use from 1961, as temperatures
precipitation_extra$date<-as.Date(as.character(precipitation_extra$date))
precipitation_extra$precipitation<-as.numeric(as.character(precipitation_extra$precipitation))
precipitation_extra$year<-as.integer(as.character(precipitation_extra$year))
precipitation_extra$month<-as.integer(as.character(precipitation_extra$month))
precipitation_extra$day<-as.integer(as.character(precipitation_extra$day))
dates$date<-as.Date(as.character(dates$date))
temperature<-merge(dates,temperature,all.x=T,all.y=T)
precipitation<-merge(dates,precipitation,all.x=T,all.y=T)
```

```{r load packages, include=FALSE}
library(broom)
library(knitr)
library(car)
library(ggplot2)
library(fmsb)
library(gridExtra)
library(papeR)
library(agricolae)
library(ggthemes)
library(ggpubr)
library(lemon)
library(grid)
library(lme4)
library(lmerTest)
library(Rmisc)
library(dplyr)
library(MuMIn)
library(effects)
library(parallel)
library(beepr)
library(RColorBrewer)
library(ggridges)
library(tidyverse)
library(sciplot)
library(tidyr)
library(lubridate)
library(knitr)
library(reshape)
library(pander)
library(moments)
library(papeR)
library(MCMCglmm)
```

```{r Define ggplot themes, include=FALSE}
my_theme <- function(){
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+
  theme(legend.position="none")+theme(text=element_text(family="serif"))+
  theme(plot.title = element_text(hjust =-0.06))
}
my_theme_legend <- function(){
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+
  theme(text=element_text(family="serif"))+
  theme(plot.title = element_text(hjust =-0.06))
}
```

```{r Function to extract legend, include=FALSE}
g_legend<-function(a.gplot){
  tmp <- ggplot_gtable(ggplot_build(a.gplot))
  leg <- which(sapply(tmp$grobs, function(x) x$name) == "guide-box")
  legend <- tmp$grobs[[leg]]
  return(legend)}
```

```{r pander options, include=FALSE}
panderOptions('table.continues', '')
```

# Temperature and precipitation data manipulation

Temperature (daily mean, minimum and maximum) from two stations: Oxelösund and Södertalje  
Precipitation from one station: Åda

```{r Temperature and precipitation data, echo=FALSE}
kable(head(temperature))
kable(head(precipitation))
```

```{r Check that all years have 365/366 days, echo=FALSE, fig.height=15, fig.width=24}
ggplot(summarySE(temperature,measurevar="mean",groupvars=c("station","year")),
       aes(x=as.factor(year),y=N))+geom_point()+facet_grid(station~.)+
  my_theme()
# All but 2017 where some data missing in the end of the year 
# because of lack of availability
```

## Distributions

```{r Distributions, echo=FALSE, fig.height=4, fig.width=24}
par(mfrow=c(1,4))
hist(temperature$mean,main=NULL,cex.axis=2,cex.lab=2)
hist(temperature$min,main=NULL,cex.axis=2,cex.lab=2)
hist(temperature$max,main=NULL,cex.axis=2,cex.lab=2)
hist(precipitation$precipitation,breaks=100,main=NULL,cex.axis=2,cex.lab=2)
```

## Boxplots per month

```{r Boxplots per month, echo=FALSE, fig.height=4, fig.width=24}
par(mfrow=c(1,4))
with(temperature,plot(mean~as.factor(month),cex.axis=2,cex.lab=2))
with(temperature,plot(min~as.factor(month),cex.axis=2,cex.lab=2))
with(temperature,plot(max~as.factor(month),cex.axis=2,cex.lab=2))
with(precipitation,plot(precipitation~as.factor(month),cex.axis=2,cex.lab=2))
```

## Comparisons of mean temperatures for each year for both stations

```{r Mean temperatures for each year for both stations, warning=FALSE, include=FALSE}
data_summary <- function(data, varname, groupnames){
  summary_func <- function(x, col){
    c(mean = mean(x[[col]], na.rm=TRUE),
      sd = sd(x[[col]], na.rm=TRUE))
  }
  data_sum<-plyr::ddply(data, groupnames, .fun=summary_func,
                  varname)
  data_sum <- rename(data_sum, c("mean" = varname))
  return(data_sum)
}
```

```{r Graph mean temperatures for each year for both stations 1, echo=FALSE, fig.height=20, fig.width=18}
ggplot(data_summary(temperature, varname="mean", groupnames=c("year", "month","station")),
       aes(x=month,y=mean,colour=station))+facet_wrap(~year,ncol=6)+geom_point()+
  geom_line()+  geom_errorbar(aes(ymin=mean-sd,ymax=mean+sd),width=.2,position=position_dodge(0.05))+ 
  my_theme()+theme(legend.position = "bottom")
```

## Complete precipitation data

```{r Complete precipitation data}
nrow(subset(precipitation,is.na(precipitation))) #245 dates with missing precipitation
unique(subset(precipitation,is.na(precipitation))[2:3]) #See which years/months

# September 1978,February 1988, June 1991, February & October 1992,June & July 1999
# October-November 2017 = missing, but ignore

# Remove NA values
precipitation<-subset(precipitation,!is.na(precipitation))

#Substitute with data from Sjögärde station
precipitation_extra<-merge(dates,precipitation_extra,all.x=T,all.y=T)
precipitation<-rbind(precipitation,
                     subset(precipitation_extra,year==1978&month==9),
                     subset(precipitation_extra,year==1988&month==2),
                     subset(precipitation_extra,year==1991&month==6),
                     subset(precipitation_extra,year==1992&month==2),
                     subset(precipitation_extra,year==1992&month==10),
                     subset(precipitation_extra,year==1999&month==6),
                     subset(precipitation_extra,year==1999&month==7))
precipitation<-precipitation[order(precipitation$date),] 
```

## Complete temperature data

```{r Complete temperature data,message=FALSE,warning=FALSE}
temperature_wide<-gather(temperature[c(1:6,8,10)], variable, value,mean,min,max) %>%
  unite(var, variable, station) %>% 
  spread(var, value) #Convert to wide format with station variables
names(temperature_wide)<-c("date","year","month","day","max_O","max_S","mean_O","mean_S","min_O","min_S")

# Check for NAs
nrow(subset(temperature_wide,is.na(min_O)|is.na(min_S)))
nrow(subset(temperature_wide,is.na(mean_O)|is.na(mean_S)))
nrow(subset(temperature_wide,is.na(max_O)|is.na(max_S)))

# Models mean_S vs mean_O for each month
models_mean<-gather(
  as.data.frame(temperature_wide %>% group_by(month) %>%
                             do(models_mean=lm(mean_S ~ mean_O, data = .))%>%
                             tidy(models_mean))[1:3],
  variable,value,estimate)%>%
  unite(var,variable,term)%>%
  spread(var,value)
names(models_mean)<-c("month","intercept","estimate")
models_mean

# Models min_S vs mi_O for each month
models_min<-gather(
  as.data.frame(temperature_wide %>% group_by(month) %>%
                             do(models_min=lm(min_S ~ min_O, data = .))%>%
                             tidy(models_min))[1:3],
  variable,value,estimate)%>%
  unite(var,variable,term)%>%
  spread(var,value)
names(models_min)<-c("month","intercept","estimate")
models_min

# Models max_S vs max_O for each month
models_max<-gather(
  as.data.frame(temperature_wide %>% group_by(month) %>%
                             do(models_max=lm(max_S ~ max_O, data = .))%>%
                             tidy(models_max))[1:3],
  variable,value,estimate)%>%
  unite(var,variable,term)%>%
  spread(var,value)
names(models_max)<-c("month","intercept","estimate")
models_max

# See in which months each var is missing
unique(subset(temperature_wide,is.na(mean_S))$month) # mean_S 
unique(subset(temperature_wide,is.na(mean_O))$month) # mean_O 
unique(subset(temperature_wide,is.na(min_S))$month) # min_S 
unique(subset(temperature_wide,is.na(min_O))$month) # min_O 
unique(subset(temperature_wide,is.na(max_S))$month) # max_S 
unique(subset(temperature_wide,is.na(max_O))$month) # max_O 

# Replace missing values by imputed values

# mean_S=estimate*mean_O+intercept
# mean_O=(mean_S-intercept)/estimate  ... (same for min and max)

# mean_S 
temperature_wide[is.na(temperature_wide$mean_S)&temperature_wide$month==4,8]<-
subset(models_mean,month==4)$intercept+
  subset(models_mean,month==4)$estimate*subset(temperature_wide,is.na(mean_S)&month==4)$mean_O

temperature_wide[is.na(temperature_wide$mean_S)&temperature_wide$month==10,8]<-
subset(models_mean,month==10)$intercept+
  subset(models_mean,month==10)$estimate*subset(temperature_wide,is.na(mean_S)&month==10)$mean_O

temperature_wide[is.na(temperature_wide$mean_S)&temperature_wide$month==11,8]<-
subset(models_mean,month==11)$intercept+
  subset(models_mean,month==11)$estimate*subset(temperature_wide,is.na(mean_S)&month==11)$mean_O

temperature_wide[is.na(temperature_wide$mean_S)&temperature_wide$month==6,8]<-
subset(models_mean,month==6)$intercept+
  subset(models_mean,month==6)$estimate*subset(temperature_wide,is.na(mean_S)&month==6)$mean_O

temperature_wide[is.na(temperature_wide$mean_S)&temperature_wide$month==3,8]<-
subset(models_mean,month==3)$intercept+
  subset(models_mean,month==3)$estimate*subset(temperature_wide,is.na(mean_S)&month==3)$mean_O

# mean_O
temperature_wide[is.na(temperature_wide$mean_O)&temperature_wide$month==6,7]<-
  (subset(temperature_wide,is.na(mean_O)&month==6)$mean_S-subset(models_mean,month==6)$intercept)/
  subset(models_mean,month==6)$estimate

temperature_wide[is.na(temperature_wide$mean_O)&temperature_wide$month==7,7]<-
  (subset(temperature_wide,is.na(mean_O)&month==7)$mean_S-subset(models_mean,month==7)$intercept)/
  subset(models_mean,month==7)$estimate

# min_S
temperature_wide[is.na(temperature_wide$min_S)&temperature_wide$month==4,10]<-
subset(models_min,month==4)$intercept+
  subset(models_min,month==4)$estimate*subset(temperature_wide,is.na(min_S)&month==4)$min_O

temperature_wide[is.na(temperature_wide$min_S)&temperature_wide$month==10,10]<-
subset(models_min,month==10)$intercept+
  subset(models_min,month==10)$estimate*subset(temperature_wide,is.na(min_S)&month==10)$min_O

temperature_wide[is.na(temperature_wide$min_S)&temperature_wide$month==11,10]<-
subset(models_min,month==11)$intercept+
  subset(models_min,month==11)$estimate*subset(temperature_wide,is.na(min_S)&month==11)$min_O

temperature_wide[is.na(temperature_wide$min_S)&temperature_wide$month==6,10]<-
subset(models_min,month==6)$intercept+
  subset(models_min,month==6)$estimate*subset(temperature_wide,is.na(min_S)&month==6)$min_O

temperature_wide[is.na(temperature_wide$min_S)&temperature_wide$month==3,10]<-
subset(models_min,month==3)$intercept+
  subset(models_min,month==3)$estimate*subset(temperature_wide,is.na(min_S)&month==3)$min_O

# min_O
temperature_wide[is.na(temperature_wide$min_O)&temperature_wide$month==6,9]<-
  (subset(temperature_wide,is.na(min_O)&month==6)$min_S-subset(models_min,month==6)$intercept)/
  subset(models_min,month==6)$estimate

temperature_wide[is.na(temperature_wide$min_O)&temperature_wide$month==7,9]<-
  (subset(temperature_wide,is.na(min_O)&month==7)$min_S-subset(models_min,month==7)$intercept)/
  subset(models_min,month==7)$estimate

# max_S
temperature_wide[is.na(temperature_wide$max_S)&temperature_wide$month==4,6]<-
subset(models_max,month==4)$intercept+
  subset(models_max,month==4)$estimate*subset(temperature_wide,is.na(max_S)&month==4)$max_O

temperature_wide[is.na(temperature_wide$max_S)&temperature_wide$month==10,6]<-
subset(models_max,month==10)$intercept+
  subset(models_max,month==10)$estimate*subset(temperature_wide,is.na(max_S)&month==10)$max_O

temperature_wide[is.na(temperature_wide$max_S)&temperature_wide$month==11,6]<-
subset(models_max,month==11)$intercept+
  subset(models_max,month==11)$estimate*subset(temperature_wide,is.na(max_S)&month==11)$max_O

temperature_wide[is.na(temperature_wide$max_S)&temperature_wide$month==6,6]<-
subset(models_max,month==6)$intercept+
  subset(models_max,month==6)$estimate*subset(temperature_wide,is.na(max_S)&month==6)$max_O

temperature_wide[is.na(temperature_wide$max_S)&temperature_wide$month==3,6]<-
subset(models_max,month==3)$intercept+
  subset(models_max,month==3)$estimate*subset(temperature_wide,is.na(max_S)&month==3)$max_O

# max_O
temperature_wide[is.na(temperature_wide$max_O)&temperature_wide$month==6,5]<-
  (subset(temperature_wide,is.na(max_O)&month==6)$max_S-subset(models_max,month==6)$intercept)/
  subset(models_max,month==6)$estimate

temperature_wide[is.na(temperature_wide$max_O)&temperature_wide$month==7,5]<-
  (subset(temperature_wide,is.na(max_O)&month==7)$max_S-subset(models_max,month==7)$intercept)/
  subset(models_max,month==7)$estimate

temperature_wide[is.na(temperature_wide$max_O)&temperature_wide$month==10,5]<-
  (subset(temperature_wide,is.na(max_O)&month==10)$max_S-subset(models_max,month==10)$intercept)/
  subset(models_max,month==10)$estimate

# Check for NAs
subset(temperature_wide,is.na(max_O)|is.na(max_S)|is.na(mean_O)|is.na(mean_S)|is.na(max_O)|is.na(max_S))
# No NAs

temperature_compl<-gather(temperature_wide, variable, value,max_O,max_S,mean_O,mean_S,min_O,min_S) %>%
  separate(variable,c("var", "station"),sep="_",remove=T,convert=F)%>%
  spread(var, value)
```

```{r Graph mean temperatures for each year for both stations 2, echo=FALSE, fig.height=20, fig.width=18}
ggplot(data_summary(temperature_compl, varname="mean", groupnames=c("year", "month","station")),
       aes(x=month,y=mean,colour=station))+facet_wrap(~year,ncol=6)+geom_point()+
  geom_line()+  geom_errorbar(aes(ymin=mean-sd,ymax=mean+sd),width=.2,position=position_dodge(0.05))+ 
  my_theme()+theme(legend.position = "bottom")
```

## Average mean, min and max temperature of the two stations for further use

```{r Temperature: average mean, min and max for the two stations}
temperature_av<-as.data.frame(temperature_compl %>% 
                         group_by(date,year,month,day) %>%
                         summarize(mean=mean(mean),
                                   min=mean(min),
                                   max=mean(max)))
kable(head(temperature_av))
nrow(subset(temperature_av,is.na(mean))) # No rows with NA values for mean
nrow(subset(temperature_av,is.na(min))) # No rows with NA values for min
nrow(subset(temperature_av,is.na(max))) # No rows with NA values for max
```

## Merge temperature and precipitation data

```{r Merge temperature and precipitation data}
weather<-merge(temperature_av,precipitation[c(1:4,6)],all.x=T,all.y=T)
kable(head(weather))
```

```{r Check for missing values}
nrow(subset(weather,is.na(mean))) #No missing values
nrow(subset(weather,is.na(min))) #No missing values
nrow(subset(weather,is.na(max))) #No missing values
nrow(subset(weather,is.na(precipitation))) 
#35 dates with missing precipitation in October-November-December 2017 --> OK
```

## Calculation of GDD and GDH

Bases considered: 3/5/7/10 ºC

GDD:  
![GDD](C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/code/GDD.png)  

GDH:  
![GDH](C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/code/GDH.png)  
```{r Calculation of GDD and GDH}
weather$GDD3<-ifelse(with(weather,((max+min)/2)-3)<0,0,with(weather,((max+min)/2)-3))
weather$GDD5<-ifelse(with(weather,((max+min)/2)-5)<0,0,with(weather,((max+min)/2)-5))
weather$GDD7<-ifelse(with(weather,((max+min)/2)-7)<0,0,with(weather,((max+min)/2)-7))
weather$GDD10<-ifelse(with(weather,((max+min)/2)-10)<0,0,with(weather,((max+min)/2)-10))
weather$GDH3<-ifelse(with(weather,max<=3),0,
                     ifelse(with(weather,max>3&min>3),with(weather,24*(min-3)+12*(max-min)),
                            with(weather,12*(max-3)^2/(max-min))))
weather$GDH5<-ifelse(with(weather,max<=5),0,
                     ifelse(with(weather,max>5&min>5),with(weather,24*(min-5)+12*(max-min)),
                            with(weather,12*(max-5)^2/(max-min))))
weather$GDH7<-ifelse(with(weather,max<=7),0,
                     ifelse(with(weather,max>7&min>7),with(weather,24*(min-7)+12*(max-min)),
                            with(weather,12*(max-7)^2/(max-min))))
weather$GDH10<-ifelse(with(weather,max<=10),0,
                     ifelse(with(weather,max>10&min>10),with(weather,24*(min-10)+12*(max-min)),
                            with(weather,12*(max-10)^2/(max-min))))
pander(head(weather), split.table = 100, style = 'rmarkdown')
```

## Calculate julian date as day with respect to vernal equinox

```{r Calculate day with respect to vernal equinox}
weather_study<-merge(weather,unique(alldata[c(1,8)])) 
#Keeps only data from 1987-1996 and 2006-2017
#Add column with date of vernal equinox
weather_study$vernal_time<-as.POSIXct(weather_study$vernal,format="%Y-%m-%d %H:%M:%S")
weather_study$vernal<-as.Date(substring(weather_study$vernal,1,10),format="%Y-%m-%d")
weather_study$date_julian<-as.numeric(with(weather_study,as.POSIXct(date)-vernal_time)/60/24)
```

## Calculations weather by month
Calculate monthly means of temperature and montly sums of precipitation, GDD and GDH
```{r Montly data, warning=FALSE,message=FALSE}
mean_weather1<-plyr::join_all(list(
    aggregate(mean~year+month,data=weather_study,FUN=mean), #Monthly means of mean daily temperature
    aggregate(min~year+month,data=weather_study,FUN=mean), #Monthly means of min daily temperature
    aggregate(max~year+month,data=weather_study,FUN=mean), #Monthly means of max daily temperature
    aggregate(precipitation~year+month,data=weather_study,FUN=sum),#Monthly sums of precipitation
    aggregate(GDD3~year+month,data=weather_study,FUN=sum),          #Monthly sums of GDD3
    aggregate(GDD5~year+month,data=weather_study,FUN=sum),          #Monthly sums of GDD5
    aggregate(GDD7~year+month,data=weather_study,FUN=sum),          #Monthly sums of GDD7
    aggregate(GDD10~year+month,data=weather_study,FUN=sum),         #Monthly sums of GDD10
    aggregate(GDH3~year+month,data=weather_study,FUN=sum),          #Monthly sums of GDH3
    aggregate(GDH5~year+month,data=weather_study,FUN=sum),          #Monthly sums of GDH5
    aggregate(GDH7~year+month,data=weather_study,FUN=sum),          #Monthly sums of GDH7
    aggregate(GDH10~year+month,data=weather_study,FUN=sum)),        #Monthly sums of GDH10       
    by = NULL, type = "left", match="all")
mean_weather2<-gather(mean_weather1, variable, value,mean,min,max,precipitation,
               GDD3,GDD5,GDD7,GDD10,GDH3,GDH5,GDH7,GDH10) %>%
               unite(var, variable, month) %>% 
               spread(var, value) #Convert to wide format with monthly variables
pander(head(mean_weather1), split.table = 100, style = 'rmarkdown')
```

# Calculations FFD stats
Calculate mean, variance, duration, skewness and kurtosis of FFD and merge with previous data

```{r Calculate mean, variance, duration, skewness and kurtosis of FFD and merge with previous data}
mean_weather3<-merge(mean_weather2,
               as.data.frame(alldata %>% filter(!is.na(alldata$FFD)) %>% 
                                         dplyr::select(year,FFD)  %>%
                                         dplyr::group_by(year) %>% 
                                         dplyr::summarise(FFD_mean=mean(FFD),FFD_var=var(FFD),
                                         FFD_dur=range(FFD)[2]-range(FFD)[1],
                                         FFD_skew=skewness(FFD),FFD_kurt=kurtosis(FFD))
                                         )) 
names(mean_weather3)
```

# Calculations cumulated GDD/GDH
Sum of GDD/GDH until each date, starting from the start of the year

```{r Calculate cumulated GDD/GDH}
#From the start of the year
weather_study<-as.data.frame(weather_study %>% 
                                dplyr::group_by(year) %>%
                                dplyr::arrange (date) %>%
                                dplyr::mutate(cumGDD3=cumsum(x = GDD3),
                                              cumGDD5=cumsum(x = GDD5),
                                              cumGDD7=cumsum(x = GDD7),
                                              cumGDD10=cumsum(x = GDD10),
                                              cumGDH3=cumsum(x = GDH3),
                                              cumGDH5=cumsum(x = GDH5),
                                              cumGDH7=cumsum(x = GDH7),
                                              cumGDH10=cumsum(x = GDH10)))
```

Merge with previous data
```{r Merge with other data}
weather_study$FFD<-weather_study$date_julian
alldata_weather<-merge(alldata, weather_study[c(1,5:16,20:28)],all.x=T,all.y=F)
```

```{r Fix cases where merge by FFD did not work, include=TRUE}
subset(alldata_weather,is.na(mean)&!is.na(FFD))[1:2] #Merge by FFD worked in all?
tomerge<-rbind(
  subset(weather_study,FFD>65&FFD<66&year==1992)[c(1,5:16,20:28)],
  subset(weather_study,FFD>51&FFD<52&year==2006)[c(1,5:16,20:28)],
  subset(weather_study,FFD>55&FFD<56&year==2006)[c(1,5:16,20:28)],
  subset(weather_study,FFD>60&FFD<61&year==2006)[c(1,5:16,20:28)],
  subset(weather_study,FFD>43&FFD<44&year==2007)[c(1,5:16,20:28)],
  subset(weather_study,FFD>47&FFD<48&year==2007)[c(1,5:16,20:28)],
  subset(weather_study,FFD>48&FFD<49&year==2007)[c(1,5:16,20:28)],
  subset(weather_study,FFD>51&FFD<51.3&year==2007)[c(1,5:16,20:28)],
  subset(weather_study,FFD>51.3&FFD<53&year==2007)[c(1,5:16,20:28)],
  subset(weather_study,FFD>53&FFD<54&year==2007)[c(1,5:16,20:28)],
  subset(weather_study,FFD>56&FFD<56.3&year==2007)[c(1,5:16,20:28)],
  subset(weather_study,FFD>56.3&FFD<58&year==2007)[c(1,5:16,20:28)],
  subset(weather_study,FFD>59&FFD<60&year==2007)[c(1,5:16,20:28)],
  subset(weather_study,FFD>60&FFD<61&year==2007)[c(1,5:16,20:28)],
  subset(weather_study,FFD>61&FFD<62&year==2007)[c(1,5:16,20:28)],
  subset(weather_study,FFD>62&FFD<63&year==2007)[c(1,5:16,20:28)],
  subset(weather_study,FFD>54&FFD<55&year==2009)[c(1,5:16,20:28)],
  subset(weather_study,FFD>56&FFD<57&year==2010)[c(1,5:16,20:28)],
  subset(weather_study,FFD>48&FFD<49&year==2011)[c(1,5:16,20:28)],
  subset(weather_study,FFD>50&FFD<51&year==2011)[c(1,5:16,20:28)],
  subset(weather_study,FFD>54&FFD<55&year==2011)[c(1,5:16,20:28)],
  subset(weather_study,FFD>61&FFD<62&year==2011)[c(1,5:16,20:28)],
  subset(weather_study,FFD>52&FFD<53&year==2012)[c(1,5:16,20:28)],
  subset(weather_study,FFD>53&FFD<54&year==2012)[c(1,5:16,20:28)],
  subset(weather_study,FFD>56&FFD<57&year==2012)[c(1,5:16,20:28)],
  subset(weather_study,FFD>63&FFD<64&year==2012)[c(1,5:16,20:28)],
  subset(weather_study,FFD>49&FFD<50&year==2014)[c(1,5:16,20:28)],
  subset(weather_study,FFD>55&FFD<55.8&year==2014)[c(1,5:16,20:28)],
  subset(weather_study,FFD>55.8&FFD<57&year==2014)[c(1,5:16,20:28)],
  subset(weather_study,FFD>42&FFD<43&year==2015)[c(1,5:16,20:28)],
  subset(weather_study,FFD>47&FFD<48&year==2015)[c(1,5:16,20:28)],
  subset(weather_study,FFD>52&FFD<53&year==2015)[c(1,5:16,20:28)],
  subset(weather_study,FFD>59&FFD<60&year==2015)[c(1,5:16,20:28)],
  subset(weather_study,FFD>62&FFD<63&year==2015)[c(1,5:16,20:28)],
  subset(weather_study,FFD>64&FFD<65&year==2017)[c(1,5:16,20:28)],
  subset(weather_study,FFD>65&FFD<66&year==2017)[c(1,5:16,20:28)],
  subset(weather_study,FFD>66&FFD<67&year==2017)[c(1,5:16,20:28)],
  subset(weather_study,FFD>67&FFD<68&year==2017)[c(1,5:16,20:28)])

tomerge$FFD_r<-round(tomerge$FFD,2)
alldata_weather$FFD_r<-round(alldata_weather$FFD,2)

head(tomerge)
head(subset(alldata_weather,is.na(mean)&!is.na(FFD)))

#Substitute by hand in OpenOffice Calc NA values in weather columns of alldata_weather by values in #tomerge, matching by closest FFD_r value
write.table(alldata_weather,
             file="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/alldata_weather.csv",
             sep="\t",dec=",",col.names=T,row.names=F)
write.table(tomerge,
             file="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/tomerge.csv",
             sep="\t",dec=",",col.names=T,row.names=F)
```

Load new data with some missing values for weather manually substituted in OpenOffice Calc
(merging by date of FFD did not work in cases where FFD was imputed, because that FFD did not correspond exactly to a "real" date - I merged it manually with the closest value)

```{r Load new data with some missing values for weather manually substituted in OpenOffice Calc}
alldata_weather_subs<-read.table("C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/alldata_weather_subs.csv",header=T,sep="\t",dec=".")
nrow(subset(alldata_weather_subs,is.na(mean)&!is.na(FFD))) #No rows with missing weather data
nrow(subset(alldata_weather_subs,n_fr>cum_n_fl)) #No cases where n_fruits>n_flowers
```

# Calculations proportion of plants that have started flowering at each FFD

```{r Calculate proportion of plants flowering at each FFD}
#Number of plants flowering per year at each FFD
alldata_weather_subs$year<-as.factor(alldata_weather_subs$year)
alldata_agg<- aggregate(FFD~cumGDD3+cumGDD5+cumGDD7+cumGDD10+cumGDH3+cumGDH5+cumGDH7+cumGDH10+year,
                        data=alldata_weather_subs[c(1:3,35:42)],FUN=length)

#Cumulated number of plants flowering per year at each FFD
alldata_agg<-as.data.frame(alldata_agg %>% 
                dplyr::group_by(year) %>%
                dplyr::mutate(n_cum_FFD = cumsum(x = FFD)))

#Calculate proportion of plants flowering per year at each FFD
max_nflowering<-aggregate(n_cum_FFD ~year, data=alldata_agg,FUN=max)
max_nflowering$max_nflowering<-max_nflowering$n_cum_FFD
max_nflowering$n_cum_FFD<-NULL

alldata_agg<-merge(alldata_agg,max_nflowering)
alldata_agg$prop_fl<-alldata_agg$n_cum_FFD/alldata_agg$max_nflowering
```

# Models of proportion of plants that have started flowering against cumulated GDD/GDH

```{r Models prop_fl against cumulated GDD/GDH, warning=FALSE}
#Fit univariate binomial GLMs of prop_fl against each predictor
models1<-lapply(names(alldata_agg)[2:9], 
         function(x) {glm(substitute(prop_fl ~ scale(i), list(i = as.name(x))),
                          family=binomial, data = alldata_agg)})

models1_summary<-lapply(X = models1, FUN = summary)%>% lapply(prettify) %>% bind_rows() 
models1_summary<-models1_summary[c(1:2,5,7)]
names(models1_summary)<-c("variable","Estimate","P","sig")
models1_summary<-subset(models1_summary,!variable=="(Intercept)")
models1_summary<-cbind(models1_summary,sapply(lapply(X = models1, FUN = NagelkerkeR2), "[[", 2))
names(models1_summary)[5]<-"Rsquare"
kable(arrange(subset(models1_summary,sig=="*"|sig=="**"|sig=="***"),desc(Rsquare)))
```

##Plots of the best models
Some plots of the best models of proportion of plants that have started flowering against cumulated GDD/GDH

```{r Plots of proportion of plants starting flowering against cumulated GDD/GDH 1, echo=FALSE, fig.height=4, fig.width=12}
grid.arrange(ggplot(alldata_agg, aes(x=cumGDH7, y=n_cum_FFD/max_nflowering,group=year,colour=year))+
  geom_smooth(aes(weight=max_nflowering),method=glm,method.args=c(family="binomial"),se=F)+
  ylab("Proportion of plants that have started flowering")+
  xlab("Cumulated GDH7"),
ggplot(alldata_agg, aes(x=cumGDH5, y=n_cum_FFD/max_nflowering,group=year,colour=year))+
  geom_smooth(aes(weight=max_nflowering),method=glm,method.args=c(family="binomial"),se=F)+
  ylab("Proportion of plants that have started flowering")+
  xlab("Cumulated GDH5"),ncol=2)
```

```{r Plots of proportion of plants starting flowering against cumulated GDD/GDH 2, echo=FALSE, fig.height=4, fig.width=12}
grid.arrange(ggplot(alldata_agg, aes(x=cumGDD7, y=n_cum_FFD/max_nflowering,group=year,colour=year))+
  geom_smooth(aes(weight=max_nflowering),method=glm,method.args=c(family="binomial"),se=F)+
  ylab("Proportion of plants that have started flowering")+
  xlab("Cumulated GDD7"),
ggplot(alldata_agg, aes(x=cumGDD5, y=n_cum_FFD/max_nflowering,group=year,colour=year))+
  geom_smooth(aes(weight=max_nflowering),method=glm,method.args=c(family="binomial"),se=F)+
  ylab("Proportion of plants that have started flowering")+
  xlab("Cumulated GDD5"),ncol=2)
```

# Plots for year 1990

Year 1990 shows high values of GDD/GDH  
Some plots to look at these high values

```{r 1990, echo=FALSE}
ggplot(weather_study,aes(date_julian,mean))+geom_line(size=0.5)+facet_wrap(~year,ncol=6)+
  ggtitle("Mean temperatures for all years")+xlab("Date (number of days since vernal equinox)")+
  ylab("Mean temperature")+geom_hline(yintercept=5,color="blue")

ggplot(subset(weather_study,year==1990),aes(date_julian,mean))+geom_line()+ggtitle("1990 temperatures")+
  xlab("Date (number of days since vernal equinox)")+ylab("Mean temperature")+
  geom_hline(yintercept=5,color="blue")

ggplot(weather_study,aes(date_julian,cumGDD3))+geom_line()+facet_wrap(~year)+
  ggtitle("Cumulated GDD3 against julian date")+
  xlab("Date (number of days since vernal equinox)")+ylab("Cumulated GDD3")

weather_study$year<-as.factor(weather_study$year)

ggplot(weather_study,aes(date_julian,GDD3,color=year))+geom_smooth(method="loess",se=F,size=0.5)+
  xlab("Date (number of days since vernal equinox)")+ylab("GDD3")+
  ggtitle("GDD3 against julian date")+geom_point(size=0.1)

grid.arrange(ggplot(mean_weather3,aes(year,GDD3_1))+
  geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD January")+
  scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ggplot(mean_weather3,aes(year,GDD3_2))+
  geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD February")+
  scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ggplot(mean_weather3,aes(year,GDD3_3))+
  geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD March")+
  scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ggplot(mean_weather3,aes(year,GDD3_4))+
  geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD April")+
  scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ggplot(mean_weather3,aes(year,GDD3_5))+
  geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD May")+
  scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ggplot(mean_weather3,aes(year,GDD3_6))+
  geom_bar(stat="identity",aes(fill = year==1990))+ylab("GDD June")+
  scale_fill_manual(values=c("#999999","#D55E00"))+theme(legend.position="none"),
ncol=2,top="GDD for different months for each year, 1990 in red")
```

GDD are very high in February and March 1990 - many days above the base temperature in these months.

# Select data for analyses paper

```{r Select data and look at variables, echo=TRUE}
alldata_weather_subs$n_fl<-alldata_weather_subs$cum_n_fl
alldata_weather_subs$cum_n_fl<-NULL
alldata_weather_subs$n_fl_action<-alldata_weather_subs$cum_n_fl_action
alldata_weather_subs$cum_n_fl_action<-NULL
data_sel<-subset(alldata_weather_subs,!is.na(n_fl)&!is.na(FFD)) 
#Select data where both FFD and n_fl are available
nrow(subset(data_sel,is.na(n_intact_seeds))) #No NAs for seed data
```

# Calculation of relative fitness and standardized traits  
Relativization and standardization was done within each year.

```{r Relative fitness and standardized traits}
data_sel<-data.frame(
  data_sel %>% 
  group_by(year) %>% 
  mutate(n_intact_seeds_rel=n_intact_seeds/mean(n_intact_seeds)) %>% #Relative fitness
  mutate(FFD_std=(FFD-mean(FFD))/sd(FFD)) %>%                        #Standardized FFD
  mutate(n_fl_std=(n_fl-mean(n_fl))/sd(n_fl)))                       #Standardized n_fl
```

# Calculation of position and duration of flowering season

## Calculate proportion of plants flowering per year at each date

```{r Calculate proportion of plants flowering per year at each date}
propfl<-as.data.frame(aggregate(id~FFD+year,data=alldata_weather_subs[c(1:3)],FUN=length) %>% 
        group_by(year) %>%
        mutate(n_cum_FFD = cumsum(x = id))) #Cumulated n plants fl per yr at each FFD

max_flowering<-aggregate(n_cum_FFD ~year, data=propfl,FUN=max)
max_flowering$max_flowering<-max_flowering$n_cum_FFD
max_flowering$n_cum_FFD<-NULL

propfl<-merge(propfl,max_flowering)
propfl$prop_fl<-propfl$n_cum_FFD/propfl$max_flowering
```

## Models proportion of plants flowering per year against date

```{r}
models_propfl<-propfl %>% 
  group_by(year) %>% 
  do(model = glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD, data = .,family=binomial))%>%
  tidy(model)
models_propfl
```

```{r Plot proportion of plants flowering per year at each date, echo=FALSE, fig.height=4, fig.width=8}
ggplot(propfl, aes(x=FFD, y=n_cum_FFD/max_flowering,group=year,colour=year))+
  geom_smooth(aes(weight=max_flowering),method=glm,method.args=c(family="binomial"),se=F)+
  geom_point()+
  ylab("Proportion of plants that have started flowering")+
  xlab("Date from vernal equinox")
```

## Calculate dates when 10%, 20%, 80% and 90% of plants have started flowering in each year

Dates are calculated using the binomial models (calculations not shown).

```{r Calculate date when %s of plants have started flowering, include=FALSE}
findInt <- function(model, value) {
    function(x) {
        predict(model, data.frame(FFD=x), type="response") - value
     }
} # Function to predict x from y in binomial GLM
#Calculate date when 10% of plants have started flowering
date_10<-c(uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1987),family=binomial), .1), range(subset(propfl,year==1987)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1988),family=binomial), .1), range(subset(propfl,year==1988)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1989),family=binomial), .1), range(subset(propfl,year==1989)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1990),family=binomial), .1), range(subset(propfl,year==1990)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1991),family=binomial), .1), range(subset(propfl,year==1991)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1992),family=binomial), .3), range(subset(propfl,year==1992)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1993),family=binomial), .1), range(subset(propfl,year==1993)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1994),family=binomial), .309), range(subset(propfl,year==1994)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1995),family=binomial), .227), range(subset(propfl,year==1995)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1996),family=binomial), .1), range(subset(propfl,year==1996)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2006),family=binomial), .1), range(subset(propfl,year==2006)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2007),family=binomial), .1), range(subset(propfl,year==2007)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2008),family=binomial), .109), range(subset(propfl,year==2008)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2009),family=binomial), .1), range(subset(propfl,year==2009)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2010),family=binomial), .151), range(subset(propfl,year==2010)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2011),family=binomial), .1), range(subset(propfl,year==2011)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2012),family=binomial), .1), range(subset(propfl,year==2012)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2013),family=binomial), .177), range(subset(propfl,year==2013)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2014),family=binomial), .1), range(subset(propfl,year==2014)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2015),family=binomial), .1), range(subset(propfl,year==2015)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2016),family=binomial), .1), range(subset(propfl,year==2016)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2017),family=binomial), .1), range(subset(propfl,year==2017)$FFD))$root)

#Calculate date when 90% of plants have started flowering
date_90<-c(uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1987),family=binomial), .9), range(subset(propfl,year==1987)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1988),family=binomial), .9), range(subset(propfl,year==1988)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1989),family=binomial), .9), range(subset(propfl,year==1989)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1990),family=binomial), .9), range(subset(propfl,year==1990)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1991),family=binomial), .9), range(subset(propfl,year==1991)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1992),family=binomial), .9), range(subset(propfl,year==1992)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1993),family=binomial), .9), range(subset(propfl,year==1993)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1994),family=binomial), .9), range(subset(propfl,year==1994)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1995),family=binomial), .9), range(subset(propfl,year==1995)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==1996),family=binomial), .9), range(subset(propfl,year==1996)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2006),family=binomial), .9), range(subset(propfl,year==2006)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2007),family=binomial), .9), range(subset(propfl,year==2007)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2008),family=binomial), .9), range(subset(propfl,year==2008)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2009),family=binomial), .9), range(subset(propfl,year==2009)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2010),family=binomial), .9), range(subset(propfl,year==2010)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2011),family=binomial), .9), range(subset(propfl,year==2011)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2012),family=binomial), .9), range(subset(propfl,year==2012)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2013),family=binomial), .9), range(subset(propfl,year==2013)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2014),family=binomial), .9), range(subset(propfl,year==2014)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2015),family=binomial), .9), range(subset(propfl,year==2015)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2016),family=binomial), .9), range(subset(propfl,year==2016)$FFD))$root,
uniroot(findInt(glm(cbind(n_cum_FFD,max_flowering-n_cum_FFD) ~ FFD,data = subset(propfl,year==2017),family=binomial), .9), range(subset(propfl,year==2017)$FFD))$root)
```

```{r Dates when 10% and 90% of plants have started flowering}
dates_fl<-data.frame(year=c(1987:1996,2006:2017),date_10,date_90)
head(dates_fl)
```

## Calculate other metrics of the flowering season and merge

```{r Calculation of position and duration of flowering season}
fl_pos_dur<-merge(as.data.frame(alldata %>% filter(!is.na(alldata$FFD)) %>% 
            dplyr::select(year,FFD)  %>%
            dplyr::group_by(year) %>% 
            dplyr::summarise(FFD_mean=mean(FFD),FFD_first=min(FFD), FFD_last=max(FFD),
                             FFD_var=var(FFD),FFD_dur=range(FFD)[2]-range(FFD)[1],
                             FFD_skew=skewness(FFD),FFD_kurt=kurtosis(FFD))),dates_fl)
fl_pos_dur$days_90_10<-with(fl_pos_dur,date_90-date_10) # Another measure of duration
head(fl_pos_dur)
mean_weather4<-merge(mean_weather3,fl_pos_dur[c(1,3:4,9:11)])
data_sel<-merge(data_sel,fl_pos_dur)
```

# Selection differentials for each year

## FFD, linear

```{r Selection differentials FFD linear}
seldiffs_FFD<-data.frame(data_sel %>% group_by(year) %>% 
  do(model = lm(n_intact_seeds_rel ~ FFD_std, data = .)) %>% tidy(model))
seldiffs_FFD_nobs<-data.frame(data_sel %>% group_by(year) %>% 
  do(nobs = nobs(lm(n_intact_seeds_rel ~ FFD_std, data = .)))) #N observations for each year
seldiffs_FFD_nobs
seldiffs_FFD$sig<-ifelse(seldiffs_FFD$p.value<0.05,"*","") 
kable(subset(seldiffs_FFD,term=="FFD_std"),digits=3)  #Linear selection differentials for FFD
#FFD * (selection for early flowering) in all years but 2009,2013,2015,2017
```

## FFD, quadratic

```{r Selection differentials FFD quadratic}
seldiffs_FFD_q<-data.frame(data_sel %>% group_by(year) %>% 
  do(model = lm(n_intact_seeds_rel ~ FFD_std+I(FFD_std^2), data = .)) %>% tidy(model))
seldiffs_FFD_q$sig<-ifelse(seldiffs_FFD_q$p.value<0.05,"*","") 
seldiffs_FFD_q$estimate<-ifelse(seldiffs_FFD_q$term=="I(FFD_std^2)",2*(seldiffs_FFD_q$estimate),
                                seldiffs_FFD_q$estimate)
seldiffs_FFD_q$std.error<-ifelse(seldiffs_FFD_q$term=="I(FFD_std^2)",2*(seldiffs_FFD_q$std.error),
                                seldiffs_FFD_q$std.error)
#Double Quadratic regression coefficients and standard errors
kable(subset(seldiffs_FFD_q,term=="I(FFD_std^2)"),digits=3)  #Quadratic selection differentials for FFD
#I(FFD_std^2) * (disruptive selection - increases variance) in 2008 and 2012
```

## Number of flowers, linear

```{r Selection differentials nfl linear}
seldiffs_nfl<-data.frame(data_sel %>% group_by(year) %>% 
  do(model = lm(n_intact_seeds_rel ~ n_fl_std, data = .)) %>% tidy(model))
seldiffs_nfl$sig<-ifelse(seldiffs_nfl$p.value<0.05,"*","") 
kable(subset(seldiffs_nfl,term=="n_fl_std"),digits=3)  #Linear selection differentials for nfl
#nfl * (selection for high number of flowers) in all years but 1992,1995,2009,2010,2013,2014,2015,2017
```

## Number of flowers, quadratic

```{r Selection differentials nfl quadratic}
seldiffs_nfl_q<-data.frame(data_sel %>% group_by(year) %>% 
  do(model = lm(n_intact_seeds_rel ~ n_fl_std+I(n_fl_std^2), data = .)) %>% tidy(model))
seldiffs_nfl_q$sig<-ifelse(seldiffs_nfl_q$p.value<0.05,"*","") 
seldiffs_nfl_q$estimate<-ifelse(seldiffs_nfl_q$term=="I(nfl_std^2)",2*(seldiffs_nfl_q$estimate),
                                seldiffs_nfl_q$estimate)
seldiffs_nfl_q$std.error<-ifelse(seldiffs_nfl_q$term=="I(nflD_std^2)",2*(seldiffs_nfl_q$std.error),
                                seldiffs_nfl_q$std.error)
#Double Quadratic regression coefficients and standard errors
kable(subset(seldiffs_nfl_q,term=="I(n_fl_std^2)"),digits=3)  #Quadratic selection differentials for nfl
#I(n_fl_std^2) * (stabilizing selection - decreases variance) in 1990,1992,2006,2007,2009,2010,2014
```

All selection differentials

```{r All selection differentials}
seldiffs<-rbind(subset(seldiffs_FFD,term=="FFD_std")[c(1:4,7)],
                subset(seldiffs_FFD_q,term=="I(FFD_std^2)")[c(1:4,7)],
                subset(seldiffs_nfl,term=="n_fl_std")[c(1:4,7)],
                subset(seldiffs_nfl_q,term=="I(n_fl_std^2)")[c(1:4,7)])
seldiffs$estimate<-round(seldiffs$estimate,3)
seldiffs$std.error<-round(seldiffs$std.error,3)
kable(seldiffs,digits=3) # Table S1
write.table(seldiffs,file="seldiffs.txt",sep="\t")
```

## Plots

```{r Plots selection differentials 1, echo=FALSE, message=FALSE,fig.height=10, fig.width=12}
plot_seldiffs1<-grid.arrange(
  ggplot(subset(seldiffs,term=="FFD_std"|term=="n_fl_std"), aes(x=year, y=estimate,colour=term,shape=sig))+ 
    geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.3,position=position_dodge(0.5))+
    geom_line(position=position_dodge(0.5))+geom_point(size=3,position=position_dodge(0.5))+
    scale_colour_manual(values = c("Black", "#999999"))+scale_shape_manual(values=c(1,19))+
    xlab(NULL)+ylab("Linear selection differential")+ggtitle("A)")+
    geom_hline(yintercept=0,size=0.5,colour="grey",linetype="dashed")+my_theme(),
ggplot(subset(seldiffs,term=="I(FFD_std^2)"|term=="I(n_fl_std^2)"), aes(x=year, y=estimate*2,colour=term,shape=sig))+ 
    geom_errorbar(aes(ymin=estimate*2-std.error, ymax=estimate*2+std.error), width=.3,position=position_dodge(0.5))+
    geom_line(position=position_dodge(0.5))+geom_point(size=3,position=position_dodge(0.5))+
    scale_colour_manual(values = c("Black", "#999999"))+scale_shape_manual(values=c(1,19))+
    xlab("Year")+ylab("Quadratic selection differential")+ggtitle("B)")+
    geom_hline(yintercept=0,size=0.5,colour="grey",linetype="dashed")+my_theme(),
ncol=1)
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/seldiffs1.tiff",
       plot=plot_seldiffs1,device="tiff",width=25,height=25,units="cm",dpi=300,compression="lzw")

```

```{r Plots selection differentials 2, echo=FALSE, message=FALSE,fig.height=8, fig.width=11}
plot_seldiffs2<-grid_arrange_shared_legend(
ggplot(data_sel,aes(x=FFD_std,y=n_intact_seeds_rel,color=year))+geom_smooth(method="lm",se=F)+
  xlab(NULL)+ylab("Relative number of intact seeds")+
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+my_theme()+
  ggtitle("A)")+theme(plot.title = element_text(hjust =-0.15)),
ggplot(data_sel,aes(x=n_fl_std,y=n_intact_seeds_rel,color=year))+geom_smooth(method="lm",se=F)+
  xlab(NULL)+ylab(NULL)+
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+my_theme()+
  ggtitle("A)")+theme(plot.title = element_text(hjust =-0.15,color="white")),
ggplot(data_sel,aes(x=FFD_std,y=n_intact_seeds_rel,color=year))+
  geom_smooth(method = "lm", formula = y ~ x + I(x^2), se=F)+
  xlab("Standardized first flowering date")+ylab("Relative number of intact seeds")+
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+my_theme()+
  ggtitle("B)")+theme(plot.title = element_text(hjust =-0.15)),
ggplot(data_sel,aes(x=n_fl_std,y=n_intact_seeds_rel,color=year))+
  geom_smooth(method = "lm", formula = y ~ x + I(x^2), se=F)+
  xlab("Standardized number of flowers")+ylab(NULL)+
  theme_base()+theme(plot.background=element_rect(fill="white", colour=NA))+my_theme()+
  ggtitle("B)")+theme(plot.title = element_text(hjust =-0.15,color="white")),
ncol=2,nrow=2,position="right")
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/seldiffs2.tiff",
       plot=plot_seldiffs2,device="tiff",width=25,height=20,units="cm",dpi=300,compression="lzw")
```

```{r Plots selection differentials 3, echo=FALSE, message=FALSE,fig.height=20, fig.width=12}
plot_seldiffs3<-ggplot(data_sel,aes(x=FFD_std,y=n_intact_seeds_rel))+facet_wrap(~year,ncol=4)+
  geom_smooth(method="lm",se=T,color="black",fill="#999999",size=0.6)+
  geom_smooth(method = "lm", formula = y ~ x + I(x^2), se=T,fill="#99CCFF",size=0.6)+
  xlab("Standardized first flowering date")+ylab("Relative number of intact seeds")+
  my_theme()
plot_seldiffs3
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/seldiffs3.tiff",
       plot=plot_seldiffs3,device="tiff",width=14,height=22,units="cm",dpi=300,compression="lzw")
```

```{r Plots selection differentials 4, echo=FALSE, message=FALSE,fig.height=20, fig.width=12}
plot_seldiffs4<-ggplot(data_sel,aes(x=n_fl_std,y=n_intact_seeds_rel))+facet_wrap(~year,ncol=4)+
  geom_smooth(method="lm",se=T,color="black",fill="#999999",size=0.6)+
  geom_smooth(method = "lm", formula = y ~ x + I(x^2), se=T,fill="#99CCFF",size=0.6)+
  xlab("Standardized number of flowers")+ylab("Relative number of intact seeds")+
  my_theme()
plot_seldiffs4
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/seldiffs4.tiff",
       plot=plot_seldiffs4,device="tiff",width=14,height=22,units="cm",dpi=300,compression="lzw")
```

# Selection gradients for each year

## FFD, linear

```{r Selection gradients FFD linear}
selgrads_FFD<-data.frame(data_sel %>% group_by(year) %>% 
  do(model = lm(n_intact_seeds_rel ~ FFD_std+n_fl_std, data = .)) %>% tidy(model))
selgrads_FFD$sig<-ifelse(selgrads_FFD$p.value<0.05,"*","") 
kable(subset(selgrads_FFD,term=="FFD_std"),digits=3)  #Linear selection gradients for FFD
#FFD * (selection for early flowering) in 1991,1992,1993,1994,2007,2010,2012,2014
```

## FFD, quadratic and correlational

```{r Selection gradients FFD quadratic}
selgrads_FFD_q<-data.frame(data_sel %>% group_by(year) %>% 
  do(model = lm(n_intact_seeds_rel ~ FFD_std+I(FFD_std^2)+n_fl_std+I(n_fl_std^2)+FFD_std:n_fl_std, data = .)) %>% tidy(model))
selgrads_FFD_q$sig<-ifelse(selgrads_FFD_q$p.value<0.05,"*","") 
kable(subset(selgrads_FFD_q,term=="I(FFD_std^2)"),digits=3)  
#Quadratic selection gradients for FFD 
#I(FFD_std^2) * (stabilizing selection - decreases variance) in 2015
kable(subset(selgrads_FFD_q,term=="FFD_std:n_fl_std"),digits=3)  
#Correlational selection gradients
#FFD_std:n_fl_std* (correlational selection) in 1988,2009 and 2016
```

All selection gradients

```{r All selection gradients}
selgrads<-rbind(subset(selgrads_FFD,term=="FFD_std")[c(1:4,7)],
                subset(selgrads_FFD_q,term=="I(FFD_std^2)")[c(1:4,7)],
                subset(selgrads_FFD_q,term=="FFD_std:n_fl_std")[c(1:4,7)])
selgrads$estimate<-round(selgrads$estimate,3)
selgrads$std.error<-round(selgrads$std.error,3)
kable(selgrads,digits=3) # Table S2
write.table(selgrads,file="selgrads.txt",sep="\t")
```

## Plots

```{r Plots selection gradients 1, echo=FALSE, message=FALSE,fig.height=6, fig.width=12}
plot_selgrads1<-ggplot(subset(selgrads_FFD,term=="FFD_std"), aes(x=year, y=estimate,colour=term,shape=sig))+ 
    geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.3,position=position_dodge(0.5))+
    geom_line(position=position_dodge(0.5))+geom_point(size=3,position=position_dodge(0.5))+
    scale_colour_manual(values = c("Black", "#999999"))+scale_shape_manual(values=c(1,19))+
    xlab("Year")+ylab("Linear selection gradient for first flowering day")+
    geom_hline(yintercept=0,size=0.5,colour="grey",linetype="dashed")+my_theme()
plot_selgrads1
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/selgrads1.tiff",
       plot=plot_selgrads1,device="tiff",width=25,height=12,units="cm",dpi=300,compression="lzw")
#This will be part of Fig. 1?
```

Calculate BCa confindence intervals for model estimates? (selection differentials and gradients)

# Merge data 

```{r Merge data}
selgrads_FFD_values<-subset(selgrads_FFD,term=="FFD_std")[c(1,3)]
selgrads_FFD_values$selgradFFD<-selgrads_FFD_values$estimate
selgrads_FFD_values$estimate<-NULL
data_sel_agg<-merge(mean_weather4,selgrads_FFD_values)
data_sel_agg$year<-as.factor(data_sel_agg$year)
data_sel<-merge(data_sel,data_sel_agg[c(1:145,156)],by="year")
data_sel$precipitation_13<-data_sel$precipitation_1+
  data_sel$precipitation_2+data_sel$precipitation_3
```


# Results 1: Among-year variation and trends

## Trends

### Trends in climate 22 years

```{r trend temp}
with(summarySE(data_sel, measurevar="max_3", groupvars=c("year")),tidy(lm(max_3~as.integer(year)))) #NS
with(summarySE(data_sel, measurevar="max_4", groupvars=c("year")),tidy(lm(max_4~as.integer(year)))) #NS
with(summarySE(data_sel, measurevar="max_5", groupvars=c("year")),tidy(lm(max_5~as.integer(year)))) #NS
with(summarySE(data_sel, measurevar="mean_3", groupvars=c("year")),tidy(lm(mean_3~as.integer(year)))) #NS
with(summarySE(data_sel, measurevar="mean_4", groupvars=c("year")),tidy(lm(mean_4~as.integer(year)))) #NS
with(summarySE(data_sel, measurevar="mean_5", groupvars=c("year")),tidy(lm(mean_5~as.integer(year)))) #NS
with(summarySE(data_sel, measurevar="min_3", groupvars=c("year")),tidy(lm(min_3~as.integer(year)))) #NS
with(summarySE(data_sel, measurevar="min_4", groupvars=c("year")),tidy(lm(min_4~as.integer(year)))) #NS
with(summarySE(data_sel, measurevar="min_5", groupvars=c("year")),tidy(lm(min_5~as.integer(year)))) #NS
with(summarySE(data_sel, measurevar="precipitation_3", groupvars=c("year")),tidy(lm(precipitation_3~as.integer(year)))) #NS
with(summarySE(data_sel, measurevar="precipitation_4", groupvars=c("year")),tidy(lm(precipitation_4~as.integer(year)))) #NS
with(summarySE(data_sel, measurevar="precipitation_5", groupvars=c("year")),tidy(lm(precipitation_5~as.integer(year)))) #NS
```

### Trends in climate all years available

```{r Trends in climate all years, , warning=FALSE,message=FALSE}
## Calculations weather by month

## Monthly means of temperature and montly GDD and GDH
mean_temp<-plyr::join_all(list(
    aggregate(mean~year+month,data=weather,FUN=mean), #Monthly means of mean daily temperature
    aggregate(min~year+month,data=weather,FUN=mean), #Monthly means of min daily temperature
    aggregate(max~year+month,data=weather,FUN=mean), #Monthly means of max daily temperature
    aggregate(GDD3~year+month,data=weather,FUN=sum),          #Monthly sums of GDD3
    aggregate(GDD5~year+month,data=weather,FUN=sum),          #Monthly sums of GDD5
    aggregate(GDD7~year+month,data=weather,FUN=sum),          #Monthly sums of GDD7
    aggregate(GDD10~year+month,data=weather,FUN=sum),         #Monthly sums of GDD10
    aggregate(GDH3~year+month,data=weather,FUN=sum),          #Monthly sums of GDH3
    aggregate(GDH5~year+month,data=weather,FUN=sum),          #Monthly sums of GDH5
    aggregate(GDH7~year+month,data=weather,FUN=sum),          #Monthly sums of GDH7
    aggregate(GDH10~year+month,data=weather,FUN=sum)),        #Monthly sums of GDH10       
    by = NULL, type = "left", match="all")
mean_temp<-gather(mean_temp, variable, value,mean,min,max,
               GDD3,GDD5,GDD7,GDD10,GDH3,GDH5,GDH7,GDH10) %>%
               unite(var, variable, month) %>% 
               spread(var, value) #Convert to wide format with monthly variables

## Monthly sums of precipitation
mean_prec<-aggregate(precipitation~year+month,data=weather,FUN=sum) #Monthly sums of precipitation
mean_prec<-gather(mean_prec, variable, value,precipitation) %>%
               unite(var, variable, month) %>% 
               spread(var, value) #Convert to wide format with monthly variables

with(summarySE(mean_temp, measurevar="max_3", groupvars=c("year")),tidy(lm(max_3~as.integer(year)))) #*
with(summarySE(mean_temp, measurevar="max_4", groupvars=c("year")),tidy(lm(max_4~as.integer(year)))) #*
with(summarySE(mean_temp, measurevar="max_5", groupvars=c("year")),tidy(lm(max_5~as.integer(year)))) #*
with(summarySE(mean_temp, measurevar="mean_3", groupvars=c("year")),tidy(lm(mean_3~as.integer(year)))) #*
with(summarySE(mean_temp, measurevar="mean_4", groupvars=c("year")),tidy(lm(mean_4~as.integer(year)))) #*
with(summarySE(mean_temp, measurevar="mean_5", groupvars=c("year")),tidy(lm(mean_5~as.integer(year)))) #*
with(summarySE(mean_temp, measurevar="min_3", groupvars=c("year")),tidy(lm(min_3~as.integer(year)))) #*
with(summarySE(mean_temp, measurevar="min_4", groupvars=c("year")),tidy(lm(min_4~as.integer(year)))) #*
with(summarySE(mean_temp, measurevar="min_5", groupvars=c("year")),tidy(lm(min_5~as.integer(year)))) #*
with(summarySE(mean_prec, measurevar="precipitation_3", groupvars=c("year")),tidy(lm(precipitation_3~as.integer(year)))) #NS
with(summarySE(mean_prec, measurevar="precipitation_4", groupvars=c("year")),tidy(lm(precipitation_4~as.integer(year)))) #NS
with(summarySE(mean_prec, measurevar="precipitation_5", groupvars=c("year")),tidy(lm(precipitation_5~as.integer(year)))) #NS
```

### Trends in climate 1987-2017

```{r Trends in climate 1987-2017, , warning=FALSE,message=FALSE}
with(subset(summarySE(mean_temp, measurevar="max_3", groupvars=c("year")),
     year>1986),tidy(lm(max_3~as.integer(year)))) #NS
with(subset(summarySE(mean_temp, measurevar="max_4", groupvars=c("year")),
     year>1986),tidy(lm(max_4~as.integer(year)))) #*
with(subset(summarySE(mean_temp, measurevar="max_5", groupvars=c("year")),
     year>1986),tidy(lm(max_5~as.integer(year)))) #NS
with(subset(summarySE(mean_temp, measurevar="mean_3", groupvars=c("year")),
     year>1986),tidy(lm(mean_3~as.integer(year)))) #NS
with(subset(summarySE(mean_temp, measurevar="mean_4", groupvars=c("year")),
     year>1986),tidy(lm(mean_4~as.integer(year)))) #NS
with(subset(summarySE(mean_temp, measurevar="mean_5", groupvars=c("year")),
     year>1986),tidy(lm(mean_5~as.integer(year)))) #NS
with(subset(summarySE(mean_temp, measurevar="min_3", groupvars=c("year")),
     year>1986),tidy(lm(min_3~as.integer(year)))) #NS
with(subset(summarySE(mean_temp, measurevar="min_4", groupvars=c("year")),
     year>1986),tidy(lm(min_4~as.integer(year)))) #NS
with(subset(summarySE(mean_temp, measurevar="min_5", groupvars=c("year")),
     year>1986),tidy(lm(min_5~as.integer(year)))) #NS
with(subset(summarySE(mean_prec, measurevar="precipitation_3",groupvars=c("year")),
            year>1986),tidy(lm(precipitation_3~as.integer(year)))) #NS
with(subset(summarySE(mean_prec, measurevar="precipitation_4", groupvars=c("year")),
            year>1986),tidy(lm(precipitation_4~as.integer(year)))) #NS
with(subset(summarySE(mean_prec, measurevar="precipitation_5", groupvars=c("year")),
            year>1986),tidy(lm(precipitation_5~as.integer(year)))) #NS
```

### Trend in FFD

```{r trend FFD}
data_sel$year_int<-as.integer(as.character(data_sel$year))
with(summarySE(data_sel, measurevar="FFD", groupvars=c("year_int")),tidy(lm(FFD~year_int))) #*
```

### Trend in fitness

```{r trend fitness}
with(summarySE(data_sel, measurevar="n_intact_seeds",groupvars=c("year_int")),
     tidy(lm(n_intact_seeds~year_int))) #NS
```

### Trend in selection gradients for FFD

```{r trend selgrads}
selgrads_FFD$year_int<-as.integer(as.character(selgrads_FFD$year))
with(subset(selgrads_FFD,term=="FFD_std"),tidy(lm(estimate~year_int))) #NS
```

## Proprtion of variation explained by year

### FFD

```{r prop var FFD expl by year}
with(data_sel,summary(lm(FFD~year))) #* Linear model, year=factor, Adjusted R-squared:  0.5906
r.squaredGLMM(lmer(FFD~year+(1|id),data_sel))[,1] # with id as a random factor, R2 fixed = 0.58
```

### Fitness

```{r prop var fitness expl by year}
with(data_sel,summary(lm(n_intact_seeds~year))) #* Linear model, year=factor, Adjusted R-squared:  0.1709
r.squaredGLMM(lmer(n_intact_seeds~year+(1|id),data_sel))[,1] # with id as a random factor, R2 fixed = 0.18
```

### Selection - Old approach, not used in paper

```{r prop var selection expl by year}
# Indirect selection
summary(lm(n_intact_seeds_rel ~ FFD_std,data = data_sel))$adj.r.squared
summary(lm(n_intact_seeds_rel ~ FFD_std+FFD_std:as.factor(year),data = data_sel))$adj.r.squared
(0.04958467-0.04414804)*100 #Variation in indirect selection explained by year?
# Direct selection
summary(lm(n_intact_seeds_rel ~ FFD_std+n_fl_std,data = data_sel))$adj.r.squared
summary(lm(n_intact_seeds_rel ~ FFD_std+FFD_std:as.factor(year)+n_fl_std,data = data_sel))$adj.r.squared
(0.07753877-0.071554)*100 #Variation in direct selection explained by year?
# id as random???
```

## Ranges and means

Mean daily temperature March

```{r Ranges and means 1}
round(with(summarySE(subset(weather_study,month==3),measurevar="mean", groupvars=c("year","month")),range(mean)),1)
round(with(summarySE(subset(weather_study,month==3),measurevar="mean", groupvars=c("year","month")),mean(mean)),1)
```

Mean daily temperature April

```{r Ranges and means 2}
round(with(summarySE(subset(weather_study,month==4),measurevar="mean", groupvars=c("year","month")),range(mean)),1)
round(with(summarySE(subset(weather_study,month==4),measurevar="mean", groupvars=c("year","month")),mean(mean)),1)
```

Mean daily temperature May

```{r Ranges and means 3}
round(with(summarySE(subset(weather_study,month==5),measurevar="mean", groupvars=c("year","month")),range(mean)),1)
round(with(summarySE(subset(weather_study,month==5),measurevar="mean", groupvars=c("year","month")),mean(mean)),1)
```

Mean FFD

```{r Ranges and means 4}
round(with(summarySE(data_sel, measurevar="FFD", groupvars=c("year")),range(FFD)),1)
round(with(summarySE(data_sel, measurevar="FFD", groupvars=c("year")),mean(FFD)),1)
```

Mean fitness

```{r Ranges and means 5}
round(with(summarySE(data_sel, measurevar="n_intact_seeds", groupvars=c("year")),range(n_intact_seeds)),1)
round(with(summarySE(data_sel, measurevar="n_intact_seeds", groupvars=c("year")),mean(n_intact_seeds)),1)
```

Selection gradients for FFD

```{r Ranges and means 6}
round(with(subset(selgrads_FFD,term=="FFD_std"),range(estimate)),2)
round(with(subset(selgrads_FFD,term=="FFD_std"),mean(estimate)),2)
```

## Fig. 1

```{r Fig. 1 Among-year variation, echo=FALSE, fig.height=18, fig.width=12, message=FALSE}
fig1<-grid.arrange(
# Spring temperature
ggplot(summarySE(subset(subset(weather,year>1986),month==3|month==4|month==5), 
                 measurevar="mean", groupvars=c("year","month")),
aes(x=as.integer(as.character(year)),y=mean,color=as.factor(month)))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.3)+geom_point(size=3)+
  xlab(NULL)+ylab("\nMean daily temperature")+ggtitle("A)")+my_theme()+
  scale_x_continuous(breaks=seq(1987,2017,2))+
  scale_color_manual(values=c("gray85","gray53","black")),
# FFD
ggplot(summarySE(data_sel, measurevar="FFD", groupvars=c("year")),
       aes(x=as.integer(as.character(year)),y=FFD))+geom_point()+
  geom_errorbar(aes(ymin=FFD-se, ymax=FFD+se), width=.3)+ geom_point(size=3)+
  geom_smooth(method="lm",color="black",se=F)+
  scale_x_continuous(breaks=seq(1987,2017,2))+
  xlab(NULL)+ylab("\nFirst flowering date")+ggtitle("B)")+my_theme(),
# Fitness
ggplot(summarySE(data_sel, measurevar="n_intact_seeds", groupvars=c("year")),
       aes(x=as.integer(as.character(year)),y=n_intact_seeds))+geom_point()+
  geom_errorbar(aes(ymin=n_intact_seeds-se, ymax=n_intact_seeds+se), width=.3)+ geom_point(size=3)+
  scale_x_continuous(breaks=seq(1987,2017,2))+
  xlab(NULL)+ylab("\nNumber of intact seeds")+ggtitle("C)")+my_theme(),
# Linear selection gradients for FFD
ggplot(subset(selgrads_FFD,term=="FFD_std"), 
       aes(x=as.integer(as.character(year)), y=estimate,colour=term,shape=sig))+ 
    geom_errorbar(aes(ymin=estimate-std.error, ymax=estimate+std.error), width=.3,position=position_dodge(0.5))+
    geom_point(size=3,position=position_dodge(0.5))+
    scale_colour_manual(values = c("Black", "#999999"))+scale_shape_manual(values=c(1,19))+
    scale_x_continuous(breaks=seq(1987,2017,2))+
    xlab("Year")+ylab("Selection gradient\nfor first flowering date")+
    geom_hline(yintercept=0,size=0.5,colour="grey",linetype="dashed")+ggtitle("D)")+my_theme(),
ncol=1)
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/fig1.tiff",
       plot=fig1,device="tiff",width=25,height=36,units="cm",dpi=300,compression="lzw")
```

## Fig. S1 

```{r Fig. S1, echo=FALSE, fig.height=10, fig.width=8, message=FALSE}
figS1<-grid.arrange(
  ggplot(summarySE(subset(subset(weather,year>1960),month==3),measurevar="min", groupvars=c("year")),
         aes(x=as.integer(as.character(year)),y=min))+
  geom_errorbar(aes(ymin=min-se, ymax=min+se), width=.1)+geom_point(size=3)+
  geom_smooth(method="lm",color="black")+ggtitle("A)")+
  xlab(NULL)+ylab("Min daily temperature March")+my_theme()+
  theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
  theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
  scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(-10,-8,-6,-4,-2,0,2,4,6,8))+
  scale_x_continuous(breaks=seq(1961,2017,4)),
  ggplot(summarySE(subset(subset(weather,year>1960),month==4),measurevar="min", groupvars=c("year")),
         aes(x=as.integer(as.character(year)),y=min))+
  geom_errorbar(aes(ymin=min-se, ymax=min+se), width=.1)+geom_point(size=3)+
  geom_smooth(method="lm",color="black")+ggtitle("B)")+
  xlab(NULL)+ylab("Min daily temperature April")+my_theme()+
  theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
  theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
  scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(-10,-8,-6,-4,-2,0,2,4,6,8))+
  scale_x_continuous(breaks=seq(1961,2017,4)),
  ggplot(summarySE(subset(subset(weather,year>1960),month==5),measurevar="min", groupvars=c("year")),
         aes(x=as.integer(as.character(year)),y=min))+
  geom_errorbar(aes(ymin=min-se, ymax=min+se), width=.1)+geom_point(size=3)+
  geom_smooth(method="lm",color="black")+ggtitle("C)")+
  xlab("Year")+ylab("Min daily temperature May")+my_theme()+
  theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
  theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
  scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(-10,-8,-6,-4,-2,0,2,4,6,8))+
  scale_x_continuous(breaks=seq(1961,2017,4)),
ncol=1)

ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/figS1.tiff",
       plot=figS1,device="tiff",width=25,height=33,units="cm",dpi=300,compression="lzw")
```

## Fig. S2

```{r Fig. S2, echo=FALSE, fig.height=10, fig.width=8, message=FALSE}
figS2<-grid.arrange(
  ggplot(summarySE(subset(subset(weather,year>1960),month==3),measurevar="mean", groupvars=c("year")),
         aes(x=as.integer(as.character(year)),y=mean))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+geom_point(size=3)+
  geom_smooth(method="lm",color="black")+ggtitle("A)")+
  xlab(NULL)+ylab("Mean daily temperature March")+my_theme()+
  theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
  theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
  scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(-10,-8,-6,-4,-2,0,2,4,6,8))+
  scale_x_continuous(breaks=seq(1961,2017,4)),
  ggplot(summarySE(subset(subset(weather,year>1960),month==4),measurevar="mean", groupvars=c("year")),
         aes(x=as.integer(as.character(year)),y=mean))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+geom_point(size=3)+
  geom_smooth(method="lm",color="black")+ggtitle("B)")+
  xlab(NULL)+ylab("Mean daily temperature April")+my_theme()+
  theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
  theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
  scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(-10,-8,-6,-4,-2,0,2,4,6,8))+
  scale_x_continuous(breaks=seq(1961,2017,4)),
  ggplot(summarySE(subset(subset(weather,year>1960),month==5),measurevar="mean", groupvars=c("year")),
         aes(x=as.integer(as.character(year)),y=mean))+
  geom_errorbar(aes(ymin=mean-se, ymax=mean+se), width=.1)+geom_point(size=3)+
  geom_smooth(method="lm",color="black")+ggtitle("C)")+
  xlab("Year")+ylab("Mean daily temperature May")+my_theme()+
  theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
  theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
  scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(8,10,12,14,16))+
  scale_x_continuous(breaks=seq(1961,2017,4)),
ncol=1)

ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/figS2.tiff",
       plot=figS2,device="tiff",width=25,height=33,units="cm",dpi=300,compression="lzw")
```

## Fig. S3

```{r Fig. S3, echo=FALSE, fig.height=10, fig.width=8, message=FALSE}
figS3<-grid.arrange(
  ggplot(summarySE(subset(subset(weather,year>1960),month==3),measurevar="max", groupvars=c("year")),
         aes(x=as.integer(as.character(year)),y=max))+
  geom_errorbar(aes(ymin=max-se, ymax=max+se), width=.1)+geom_point(size=3)+
  geom_smooth(method="lm",color="black")+ggtitle("A)")+
  xlab(NULL)+ylab("Max daily temperature March")+my_theme()+
  theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
  theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
  scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(0,2,4,6,8,10))+
  scale_x_continuous(breaks=seq(1961,2017,4)),
  ggplot(summarySE(subset(subset(weather,year>1960),month==4),measurevar="max", groupvars=c("year")),
         aes(x=as.integer(as.character(year)),y=max))+
  geom_errorbar(aes(ymin=max-se, ymax=max+se), width=.1)+geom_point(size=3)+
  geom_smooth(method="lm",color="black")+ggtitle("B)")+
  xlab(NULL)+ylab("Max daily temperature April")+my_theme()+
  theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
  theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
  scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(0,2,4,6,8,10,12,14,16))+
  scale_x_continuous(breaks=seq(1961,2017,4)),
  ggplot(summarySE(subset(subset(weather,year>1960),month==5),measurevar="max", groupvars=c("year")),
         aes(x=as.integer(as.character(year)),y=max))+
  geom_errorbar(aes(ymin=max-se, ymax=max+se), width=.1)+geom_point(size=3)+
  geom_smooth(method="lm",color="black")+ggtitle("C)")+
  xlab("Year")+ylab("Max daily temperature May")+my_theme()+
  theme(plot.title=element_text(hjust=-0.06,vjust=-1))+
  theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
  scale_y_continuous(labels=function(x) format(x, width=3),breaks=c(12,14,16,18,20,22))+
  scale_x_continuous(breaks=seq(1961,2017,4)),
ncol=1)

ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/figS3.tiff",
       plot=figS3,device="tiff",width=25,height=33,units="cm",dpi=300,compression="lzw")
```

## Fig. S4

```{r Fig. S4, echo=FALSE, fig.height=10, fig.width=8, message=FALSE}
figS4<-grid.arrange(
  ggplot(aggregate(precipitation ~ year,data= subset(weather,month==3),FUN=sum))+
    aes(x=as.integer(as.character(year)),y=precipitation)+
  geom_bar(stat="identity",position = "identity")+
  xlab(NULL)+ylab("Precipitation March")+ggtitle("A)")+my_theme()+
  scale_y_continuous(labels=function(x) format(x, width=3))+
  theme(plot.title=element_text(hjust=-0.07,vjust=0))+
  theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
  scale_x_continuous(breaks=seq(1945,2017,4)),
  ggplot(aggregate(precipitation ~ year+month,data= subset(weather,month==4),FUN=sum))+
    aes(x=as.integer(as.character(year)),y=precipitation)+
  geom_bar(stat="identity",position = "identity")+
  xlab(NULL)+ylab("Precipitation April")+ggtitle("D)")+my_theme()+
  scale_y_continuous(labels=function(x) format(x, width=3))+
  theme(plot.title=element_text(hjust=-0.07,vjust=0))+
  theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
  scale_x_continuous(breaks=seq(1945,2017,4)),
  ggplot(aggregate(precipitation ~ year+month,data= subset(weather,month==5),FUN=sum))+
    aes(x=as.integer(as.character(year)),y=precipitation)+
  geom_bar(stat="identity",position = "identity")+
  xlab("Year")+ylab("Precipitation May")+ggtitle("C)")+my_theme()+
  scale_y_continuous(labels=function(x) format(x, width=3))+
  theme(plot.title=element_text(hjust=-0.07,vjust=0))+
  theme(plot.margin = unit(c(0.01,0.1,0.01,0.1), "cm"))+
  scale_x_continuous(breaks=seq(1945,2017,4)),
ncol=1)

ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/figS4.tiff",
       plot=figS4,device="tiff",width=25,height=33,units="cm",dpi=300,compression="lzw")
```

# Results 2: Response of FFD for each plant, mean position and duration of flowering to climate 
## FFD for each plant (Table 1A)

```{r FFD model sel,warning=FALSE,message=FALSE}
# Variables to use
subset1<-data_sel[c(2,3,42,158:160,170:172,182:184,194:196)]
subset1[,3:15]<-scale(subset1[,3:15])
globmod_FFD<-lmer(FFD ~ max_3+max_4+max_5+mean_3+mean_4+mean_5+min_3+min_4+min_5+
                    precipitation_3+precipitation_4+precipitation_5+n_fl+(1|id),
                  data = subset1,REML=FALSE,na.action="na.fail")

# Excluding collinear variables with r > 0.5
smat1 <- abs(cor(subset1[, -c(1,2,3)])) <= .5 # TRUE: cor<=0.5,FALSE: cor>0.5
smat1[!lower.tri(smat1)] <- NA

clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust1 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust1, "subset1")
clusterEvalQ(clust1, library(lme4))
modsel_FFD<-pdredge(globmod_FFD,fixed=c("n_fl"),subset=smat1,cluster=clust1)

summary(model.avg(modsel_FFD,subset=delta<2)) # Summary averaged model
importance(modsel_FFD) # Variable importance
r.squaredGLMM(get.models(modsel_FFD,subset=1)$"1585") #R square of best model
```

## FFD for each plant with year (Table S2)

```{r FFD w year,warning=FALSE,message=FALSE}
summary(lmer(FFD ~ scale(mean_4)+scale(mean_5)+
               scale(precipitation_3)+scale(precipitation_4)+scale(n_fl)+
               as.integer(as.character(year))+(1|id),data = data_sel,
             REML=FALSE,na.action="na.fail"))
r.squaredGLMM(lmer(FFD ~ scale(mean_4)+scale(mean_5)+
               scale(precipitation_3)+scale(precipitation_4)+scale(n_fl)+
               as.integer(as.character(year))+(1|id),data = data_sel,
             REML=FALSE,na.action="na.fail"))
```

### Fig. 2: Response of FFD for each plant to climate

```{r Fig 2, echo=FALSE, fig.height=4, fig.width=19}
fig2<-grid.arrange(
  ggplot(data_sel,aes(x=mean_4,y=FFD))+ggtitle("A)")+
    geom_point(size=1)+geom_smooth(method="lm",color="black",se=F)+
    xlab("Mean daily temperature April")+ylab(NULL)+my_theme()+
    theme(plot.title=element_text(hjust=-0.13,vjust=2)),
  ggplot(data_sel,aes(x=mean_5,y=FFD))+ggtitle("B)")+
    geom_point(size=1)+geom_smooth(method="lm",color="black",se=F)+
    xlab("Mean daily temperature May")+ylab(NULL)+my_theme()+
    theme(axis.text.y=element_text(color="white"))+
    theme(plot.title=element_text(hjust=-0.13,vjust=2)),
  ggplot(data_sel,aes(x=precipitation_3,y=FFD))+ggtitle("C)")+
    geom_point(size=1)+geom_smooth(method="lm",color="black",se=F)+
    xlab("Sum of precipitation March")+ylab(NULL)+my_theme()+
    theme(axis.text.y=element_text(color="white"))+
    theme(plot.title=element_text(hjust=-0.13,vjust=2)),    ggplot(data_sel,aes(x=precipitation_4,y=FFD))+ggtitle("D)")+
    geom_point(size=1)+geom_smooth(method="lm",color="black",se=F)+
    xlab("Sum of precipitation April")+ylab(NULL)+my_theme()+
    theme(axis.text.y=element_text(color="white"))+
    theme(plot.title=element_text(hjust=-0.13,vjust=2)),
  ncol=4,left=textGrob("First flowering date",just="center",hjust=0.42,
                     gp=gpar(fontsize=16,fontfamily="serif"),rot = 90))
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/fig2.tiff",
       plot=fig2,device="tiff",width=38,height=9,units="cm",dpi=300,compression="lzw")
```

## Position (Table 1B)

```{r FFD_mean~temp}
summary(lm(FFD_mean~scale(mean_4)+scale(mean_5)+
             scale(precipitation_3)+scale(precipitation_4),data=mean_weather4))

## Including year (Table S2)
summary(lm(FFD_mean~scale(mean_4)+scale(mean_5)+
             scale(precipitation_3)+scale(precipitation_4)+
             as.integer(as.character(year)),data=mean_weather4))
```

```{r date_10~temp}
summary(lm(date_10~scale(mean_4)+scale(mean_5)+
             scale(precipitation_3)+scale(precipitation_4),data=mean_weather4))

## Including year (Table S2)
summary(lm(date_10~scale(mean_4)+scale(mean_5)+
             scale(precipitation_3)+scale(precipitation_4)+
             as.integer(as.character(year)),data=mean_weather4))
```

```{r date_90~temp}
summary(lm(date_90~scale(mean_4)+scale(mean_5)+
             scale(precipitation_3)+scale(precipitation_4),data=mean_weather4))

## Including year (Table S2)
summary(lm(date_90~scale(mean_4)+scale(mean_5)+
             scale(precipitation_3)+scale(precipitation_4)+
             as.integer(as.character(year)),data=mean_weather4))
```

## Duration (Table 1C)

```{r days_90_10~temp}
summary(lm(days_90_10~scale(mean_4)+scale(mean_5)+
             scale(precipitation_3)+scale(precipitation_4),data=mean_weather4))

## Including year  (Table S2)
summary(lm(days_90_10~scale(mean_4)+scale(mean_5)+
             scale(precipitation_3)+scale(precipitation_4)+
             as.integer(as.character(year)),data=mean_weather4))
```

### Fig. 3: Response of position and duration to climate

```{r Fig. 3 Response of position to spring temperature, echo=FALSE, fig.height=4, fig.width=10,message=FALSE,warning=FALSE}
fig3<-grid.arrange(
  ggplot(mean_weather4)+ggtitle("A)")+
    geom_point(aes(x=mean_4,y=date_10),shape=24)+
    geom_smooth(aes(x=mean_4,y=date_10),method="lm",color="black",lty="dashed",se=F)+
    geom_point(aes(x=mean_4,y=FFD_mean),shape=19)+
    geom_smooth(aes(x=mean_4,y=FFD_mean),method="lm",color="black",se=F)+
    geom_point(aes(x=mean_4,y=date_90),shape=8)+
    geom_smooth(aes(x=mean_4,y=date_90),method="lm",color="black",lty="dotted",se=F)+
    xlab("Mean daily temperature April")+ylab(NULL)+my_theme()+
    scale_y_continuous(limits=c(40,80))+
    theme(plot.title=element_text(hjust=-0.13,vjust=1))+
    theme(plot.margin = unit(c(0.07,0.2,0.07,0.2), "cm")),
  ggplot(mean_weather4)+ggtitle("B)")+
    geom_point(aes(x=mean_5,y=date_10),shape=24)+
    geom_smooth(aes(x=mean_5,y=date_10),method="lm",color="black",lty="dashed",se=F)+
    geom_point(aes(x=mean_5,y=FFD_mean),shape=19)+
    geom_smooth(aes(x=mean_5,y=FFD_mean),method="lm",color="black",se=F)+
    geom_point(aes(x=mean_5,y=date_90),shape=8)+
    geom_smooth(aes(x=mean_5,y=date_90),method="lm",color="black",lty="dotted",se=F)+
    xlab("Mean daily temperature May")+ylab(NULL)+my_theme()+
    scale_y_continuous(limits=c(40,80))+theme(axis.text.y=element_text(color="white"))+
    theme(plot.title=element_text(hjust=-0.13,vjust=1))+
    theme(plot.margin = unit(c(0.07,0.2,0.07,0.2), "cm")),
  ggplot(mean_weather4)+ggtitle("C)")+
    geom_point(aes(x=mean_4,y=days_90_10),shape=19)+
    geom_smooth(aes(x=mean_4,y=days_90_10),method="lm",color="black",se=F)+
    xlab("Mean daily temperature April")+ylab("Duration of flowering season")+my_theme()+
    theme(plot.title=element_text(hjust=-0.13,vjust=1))+
    theme(plot.margin = unit(c(0.07,0.2,0.07,0.2), "cm")),
ncol=3,left=textGrob("Day from vernal equinox",
                     gp=gpar(fontsize=16,fontfamily="serif"),rot = 90,hjust=0.46))
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/fig3.tiff",
       plot=fig3,device="tiff",width=28,height=9,units="cm",dpi=300,compression="lzw")
```

# Results 3: Response of fitness to climate

```{r Fitness~temp 1}
# Variables to use
subset2<-data_sel[c(3,20,42,158:160,170:172,182:184,194:196)]
subset2[,c(3:15)]<-scale(subset2[,c(3:15)])
globmod_fitness<-lmer(n_intact_seeds ~ max_3+max_4+max_5+mean_3+mean_4+mean_5+
                        min_3+min_4+min_5+precipitation_3+precipitation_4+precipitation_5+
                        n_fl+(1|id),data = subset2,REML=FALSE,na.action="na.fail")

# Excluding collinear variables with r > 0.5
smat2 <- abs(cor(subset2[, -c(1:3)])) <= .5 # TRUE: cor<=0.5,FALSE: cor>0.5
smat2[!lower.tri(smat2)] <- NA

clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust1 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust1, "subset2")
clusterEvalQ(clust1, library(lme4))
modsel_fitness<-pdredge(globmod_fitness,subset=smat2,fixed="n_fl",cluster=clust1)
summary(model.avg(modsel_fitness,subset=delta<2)) # Summary averaged model
importance(modsel_fitness) # Variable importance
r.squaredGLMM(get.models(modsel_fitness,subset=1)$"1794") #R square of best model
```

## Fig. S5: Response of fitness to climate

Graphs of the effect of variables taking into account that number of flowers is included in the model

```{r Fig S5, echo=FALSE, fig.height=4, fig.width=19}
#Using a model with significant variables in model averaging
effect1<-data.frame(effect(term="max_4",mod=lmer(n_intact_seeds~
         max_4+min_5+precipitation_3+precipitation_4+n_fl+(1|id),
         data=data_sel,REML=FALSE,na.action="na.fail"),
         xlevels=list(max_4=seq(7.0,13.6,0.1))))
effect2<-data.frame(effect(term="min_5",mod=lmer(n_intact_seeds~                                        max_4+min_5+precipitation_3+precipitation_4+n_fl+(1|id),
         data=data_sel,REML=FALSE,na.action="na.fail"),
         xlevels=list(min_5=seq(3.9,8.0,0.1))))
effect3<-data.frame(effect(term="precipitation_3",mod=lmer(n_intact_seeds~
         max_4+min_5+precipitation_3+precipitation_4+
         n_fl+(1|id),data=data_sel,REML=FALSE,na.action="na.fail"),
         xlevels=list(precipitation_3=seq(4.8,78.2,1))))
effect4<-data.frame(effect(term="precipitation_4",mod=lmer(n_intact_seeds~ 
         max_4+min_5+precipitation_3+precipitation_4+
         n_fl+(1|id),data=data_sel,REML=FALSE,na.action="na.fail"),
         xlevels=list(precipitation_4=seq(3.7,79.8,1))))

figS5<-grid.arrange(
  ggplot(effect1, aes(max_4,fit))+ggtitle("A)")+
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.5,fill="grey")+
    geom_smooth(method="lm",se=T,size=1,color="black",aes(max_4,fit))+
    xlab("Maximum daily temperature April")+ylab(NULL)+my_theme()+
    theme(plot.margin = unit(c(0.07,0.07,0.07,0.07), "cm"))+
    theme(plot.title=element_text(hjust=-0.12,vjust=-2))+
    scale_y_continuous(limits=c(1,11),breaks=c(2,4,6,8,10)),
  ggplot(effect2, aes(min_5,fit))+ggtitle("B)")+
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.5,fill="grey")+
    geom_smooth(method="lm",se=T,size=1,color="black",aes(min_5,fit))+
    xlab("Minimum daily temperature May")+ylab(NULL)+my_theme()+
    theme(plot.margin = unit(c(0.07,0.07,0.07,0.07), "cm"))+
    theme(plot.title=element_text(hjust=-0.12,vjust=-2))+
    scale_y_continuous(limits=c(1,11),breaks=c(2,4,6,8,10))+
    theme(axis.text.y=element_text(color="white")),
  ggplot(effect3, aes(precipitation_3,fit))+ggtitle("C)")+
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.5,fill="grey")+
    geom_smooth(method="lm",se=T,size=1,color="black",aes(precipitation_3,fit))+
    xlab("Sum of precipitation March")+ylab(NULL)+my_theme()+
    theme(plot.margin = unit(c(0.07,0.07,0.07,0.07), "cm"))+
    theme(plot.title=element_text(hjust=-0.12,vjust=-2))+
    scale_y_continuous(limits=c(1,11),breaks=c(2,4,6,8,10))+
    theme(axis.text.y=element_text(color="white")),
  ggplot(effect4, aes(precipitation_4,fit))+ggtitle("D)")+
    geom_ribbon(aes(ymin = lower, ymax = upper), alpha = 0.5,fill="grey")+
    geom_smooth(method="lm",se=T,size=1,color="black",aes(precipitation_4,fit))+
    xlab("Sum of precipitation April")+ylab(NULL)+my_theme()+
    theme(plot.margin = unit(c(0.07,0.07,0.07,0.07), "cm"))+
    theme(plot.title=element_text(hjust=-0.12,vjust=-2))+
    scale_y_continuous(limits=c(1,11),breaks=c(2,4,6,8,10))+
    theme(axis.text.y=element_text(color="white")),
  ncol=4,left=textGrob("Number of intact seeds",just="center",hjust=0.48,
                       gp=gpar(fontsize=16,fontfamily="serif"),rot = 90))
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/figS5.tiff",
       plot=figS5,device="tiff",width=35,height=9,units="cm",dpi=600)
```

# Results 4: Differences in selection among years

## Total selection (selection differentials, Table 3A)

```{r Differences in selection differentials among years}
Anova(lmer(n_intact_seeds_rel ~ FFD_std+FFD_std:year+(1|id),data = data_sel),type="II")
#Indirect selection for early flowering differs among years
```

## Direct selection (selection gradients, Table 3B)

```{r Differences in selection gradients among years}
Anova(lmer(n_intact_seeds_rel ~ FFD_std+FFD_std:year+n_fl_std+(1|id),data = data_sel),type="II")
#Direct selection for early flowering differs among years
```

# Results 5: Are differences in selection among years related to climatic conditions?
Response of selection to climate.

## Table 2A

### Total selection 

```{r GLM total}
# Variables to use
subset3<-data_sel[c(3,44:45,158:160,170:172,182:184,194:196)]
subset3[,c(4:15)]<-scale(subset3[,c(4:15)])
globmod_total_selection<-lmer(n_intact_seeds_rel ~ FFD_std+
                          FFD_std:max_3+FFD_std:max_4+FFD_std:max_5+
                          FFD_std:mean_3+FFD_std:mean_4+FFD_std:mean_5+
                          FFD_std:min_3+FFD_std:min_4+FFD_std:min_5+
                          FFD_std:precipitation_3+FFD_std:precipitation_4+
                          FFD_std:precipitation_5+(1|id),
                        data = subset3,REML=FALSE,na.action="na.fail")
# Excluding collinear variables with r > 0.5
smat3 <- abs(cor(subset3[, -c(1:3)])) <= .5 # TRUE: cor<=0.5,FALSE: cor>0.5
smat3[!lower.tri(smat3)] <- NA
rownames(smat3)<-paste("FFD_std:", names(smat3[1,1:12]),sep="")
colnames(smat3)<-paste("FFD_std:", names(smat3[1,1:12]),sep="")

clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust1 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust1, "subset3")
clusterEvalQ(clust1, library(lme4))

modsel_total_selection<-pdredge(globmod_total_selection,subset=smat3,fixed=c("FFD_std"),
                          cluster=clust1)

summary(model.avg(modsel_total_selection,subset=delta<2)) # Summary averaged model
importance(modsel_total_selection) # Variable importance
r.squaredGLMM(get.models(modsel_total_selection,subset=1)$"1696") #R square of best model

# Anova (Table 4A) with model including variables that were significant in the averaged model
Anova(lmer(n_intact_seeds_rel ~ FFD_std+FFD_std:min_4+FFD_std:precipitation_3+FFD_std:precipitation_4+
             (1|id),data = subset3,REML=FALSE,na.action="na.fail"))
```

### Direct selection 

```{r GLM direct}
# Variables to use
subset4<-data_sel[c(3,44:46,158:160,170:172,182:184,194:196)]
subset4[,c(5:16)]<-scale(subset4[,c(5:16)])
globmod_direct_selection<-lmer(n_intact_seeds_rel ~ FFD_std+n_fl_std+
                          FFD_std:max_3+FFD_std:max_4+FFD_std:max_5+
                          FFD_std:mean_3+FFD_std:mean_4+FFD_std:mean_5+
                          FFD_std:min_3+FFD_std:min_4+FFD_std:min_5+
                          FFD_std:precipitation_3+FFD_std:precipitation_4+
                          FFD_std:precipitation_5+(1|id),
                        data = subset4,REML=FALSE,na.action="na.fail")
# Excluding collinear variables with r > 0.5
smat4 <- abs(cor(subset4[, -c(1:4)])) <= .5 # TRUE: cor<=0.5,FALSE: cor>0.5
smat4[!lower.tri(smat4)] <- NA
rownames(smat4)<-paste("FFD_std:", names(smat4[1,1:12]),sep="")
colnames(smat4)<-paste("FFD_std:", names(smat4[1,1:12]),sep="")

clusterType <- if(length(find.package("snow", quiet = TRUE))) "SOCK" else "PSOCK"
clust1 <- try(makeCluster(getOption("cl.cores", 3), type = clusterType))
clusterExport(clust1, "subset4")
clusterEvalQ(clust1, library(lme4))

modsel_direct_selection<-pdredge(globmod_direct_selection,subset=smat4,
                                 fixed=c("FFD_std","n_fl_std"),cluster=clust1)

summary(model.avg(modsel_direct_selection,subset=delta<2)) # Summary averaged model
importance(modsel_direct_selection) # Variable importance
r.squaredGLMM(get.models(modsel_direct_selection,subset=1)$"1696") #R square of best model

# Anova (Table 4A) with model including variables that were significant in the averaged model
Anova(lmer(n_intact_seeds_rel ~ FFD_std+n_fl_std+FFD_std:min_4+FFD_std:precipitation_3+FFD_std:precipitation_4+
             (1|id),data = subset4,REML=FALSE,na.action="na.fail"))
```

## Fig. 4: Response of selection gradients to climate, position and duration of flowering season

```{r Fig. 4 Response of selection gradients to spring temperature, position and duration of flowering season, fig.height=5, fig.width=10, echo=FALSE,warning=FALSE}
subset4<-data_sel[c(3,44:46,158:160,170:172,182:184,194:196)]
modsel_sig<-lmer(n_intact_seeds_rel ~ FFD_std+n_fl_std+FFD_std:min_4+FFD_std:precipitation_3+
                   FFD_std:precipitation_4+(1|id),
                 data = subset4,REML=FALSE,na.action="na.fail")

interaction1<-data.frame(effect(term="FFD_std:min_4",mod=modsel_sig,
                       xlevels=list(FFD_std=seq(-3.9,4.2,0.1),
                                    min_4=seq(-0.1,3.7,0.1))))
interaction1$fit_mod<-with(interaction1,ifelse(fit<0,0,fit))

interaction2<-data.frame(effect(term="FFD_std:precipitation_3",mod=modsel_sig,
                       xlevels=list(FFD_std=seq(-3.9,4.2,0.1),
                                    precipitation_3=seq(4.8,78.2,1))))
interaction2$fit_mod<-with(interaction2,ifelse(fit<0,0,fit))

myPalette <- colorRampPalette(brewer.pal(11, "YlOrRd"))
p1<-ggplot(interaction1, aes(FFD_std,fit_mod, group = as.factor(min_4)))+
  geom_smooth(method=lm,se=F,size=0.5,aes(FFD_std,fit_mod,color=min_4))+
  xlab("Standardized first flowering date")+ylab(NULL)+ggtitle("A)")+
  my_theme()+scale_colour_gradientn(colours = myPalette(100))+
  theme(legend.position="top")+labs(colour="Minimum daily\ntemperature April")+
  theme(plot.margin = unit(c(0.1,0.3,0.1,0.3), "cm"))+
  theme(plot.title=element_text(hjust=-0.10,vjust=-16))+
  scale_y_continuous(limit=c(0,3.2))
myPalette <- colorRampPalette(brewer.pal(11, "Blues"))
p2<-ggplot(interaction2, aes(FFD_std,fit_mod, group = as.factor(precipitation_3)))+
  geom_smooth(method=lm,se=F,size=0.5,aes(FFD_std,fit_mod,color=precipitation_3))+
  xlab("Standardized first flowering date")+ylab(NULL)+ggtitle("B)")+
  my_theme()+scale_colour_gradientn(colours = myPalette(100))+
  theme(legend.position="top")+labs(colour="Sum of\nprecipitation March")+
  theme(axis.text.y=element_text(color="white"))+
  theme(plot.margin = unit(c(0.1,0.3,0.1,0.3), "cm"))+
  theme(plot.title=element_text(hjust=-0.10,vjust=-16))+
  scale_y_continuous(limit=c(0,3.2))

fig4<-grid.arrange(p1,p2,ncol=2,
                      left=textGrob("Relative number of intact seeds",
                                    just="center",hjust=0.63,
                                    gp=gpar(fontsize=16,fontfamily="serif"),rot = 90))
ggsave(filename="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/results/figures/fig4.tiff",
       plot=fig4,device="tiff",width=19,height=11,units="cm",dpi=300,compression="lzw")
```

## Proportion of among-year variation in selection explained by climatic factors

New approach, used in paper (as in Hunter et al. 2018, code suggested by M. Morrissey)

### Total selection

```{r prop among-year variation in total selection explained by climatic factors}
data_seldiff<-subset(seldiffs_FFD,term=="FFD_std")[c(1,3:4)]
names(data_seldiff)<-c("year","seldiff","SE_seldiff")
data_seldiff<-merge(data_seldiff,unique(data_sel[c(1,183,194:195)]))

myprior <- list(R = list(V=1, nu=0.002))
model_seldiff<-MCMCglmm(seldiff~min_4+precipitation_3+precipitation_4,
                        mev=data_seldiff$SE_seldiff^2,data=data_seldiff,family="gaussian",
                        nitt=500000,burnin=10000,thin=10,prior=myprior,verbose=F)
summary(model_seldiff)
head(model_seldiff$Sol)
head(model_seldiff$VCV)

nMCMC_seldiff<-dim(model_seldiff$Sol)[1] # Sample size

# To contain posterior distribution of the variance in seldiffs associated with the environment
post.Var_seldiff<-array(dim=nMCMC_seldiff)

# The posterior samples of the partial regression coefficients of seldiffs on the predictor
# variables relate to the variance in seldiffs associated with the multivariate environment
# according to: V(Y) = T(B) %*% V(X) %*% B 
# (standard expression for a variance of a linear transformation)
# V(Y) = variance of selection differentials arising from environmental variation
# V(X) = covariance matrix of the environmental variable
# B = linear transformation of X onto Y (partial regression coefficients)

# Apply this transformation to each posterior sample to generate a posterior distribution of 
# the variance in seldiffs associated with environmental variables
# This is the numerator of equation 12 in Hunter et al. 2018, for calculating
# the proportion of the total variation in selection attributed to the environmental 
# component of the model. The denominator is this quantity plus the residual variance.

# Calculate the variance, over all posterior samples
Sigma_seldiff<-var(as.matrix(model_seldiff$X[,2:4])) # Covariance matrix of environmental vars
for(i in 1:nMCMC_seldiff){
  post.Var_seldiff[i]<- t(model_seldiff$Sol[i,2:4]) %*% Sigma_seldiff %*%model_seldiff$Sol[i,2:4] 
  # Variance of seldiffs arising from environmental variation
}

# Two flavours of the estimate of the variance associated with the climate variables
# (Numerator of equation 12)
mean(post.Var_seldiff)
posterior.mode(as.mcmc(post.Var_seldiff))

# 95% credible interval of the variance
HPDinterval(as.mcmc(post.Var_seldiff))

# Visualise
par(mfrow=c(1,2))
plot(density(post.Var_seldiff))

# Two flavours of the estimate of the proportion of variance associated with the climate variables
# (Equation 12 in paper)
mean(post.Var_seldiff/(post.Var_seldiff+model_seldiff$VCV[,2])) # 0.6964514
posterior.mode(as.mcmc(post.Var_seldiff/(post.Var_seldiff+model_seldiff$VCV[,2]))) # 0.8768223

# 95% credible interval of the variance
HPDinterval(as.mcmc(post.Var_seldiff/(post.Var_seldiff+model_seldiff$VCV[,2])))

# visualise
plot(density(post.Var_seldiff/(post.Var_seldiff+model_seldiff$VCV[,2])))
```

### Direct selection

```{r prop among-year variation in direct selection explained by climatic factors}
data_selgrad<-subset(selgrads_FFD,term=="FFD_std")[c(1,3:4)]
names(data_selgrad)<-c("year","selgrad","SE_selgrad")
data_selgrad<-merge(data_selgrad,unique(data_sel[c(1,183,194:195)]))

myprior <- list(R = list(V=1, nu=0.002))
model_selgrad<-MCMCglmm(selgrad~min_4+precipitation_3+precipitation_4,
                        mev=data_selgrad$SE_selgrad^2,data=data_selgrad,family="gaussian",
                        nitt=500000,burnin=10000,thin=10,prior=myprior,verbose=F)
summary(model_selgrad)
head(model_selgrad$Sol)
head(model_selgrad$VCV)

nMCMC_selgrad<-dim(model_selgrad$Sol)[1] # Sample size

# To contain posterior distribution of the variance in selgrads associated with the environment
post.Var_selgrad<-array(dim=nMCMC_selgrad)

# The posterior samples of the partial regression coefficients of selgrads on the predictor
# variables relate to the variance in selgrads associated with the multivariate environment
# according to: V(Y) = T(B) %*% V(X) %*% B 
# (standard expression for a variance of a linear transformation)
# V(Y) = variance of selection graderentials arising from environmental variation
# V(X) = covariance matrix of the environmental variable
# B = linear transformation of X onto Y (partial regression coefficients)

# Apply this transformation to each posterior sample to generate a posterior distribution of 
# the variance in selgrads associated with environmental variables
# This is the numerator of equation 12 in Hunter et al. 2018, for calculating
# the proportion of the total variation in selection attributed to the environmental 
# component of the model. The denominator is this quantity plus the residual variance.

# Calculate the variance, over all posterior samples
Sigma_selgrad<-var(as.matrix(model_selgrad$X[,2:4])) # Covariance matrix of environmental vars
for(i in 1:nMCMC_selgrad){
  post.Var_selgrad[i]<- t(model_selgrad$Sol[i,2:4]) %*% Sigma_selgrad %*%model_selgrad$Sol[i,2:4] 
  # Variance of selgrads arising from environmental variation
}

# Two flavours of the estimate of the variance associated with the climate variables
# (Numerator of equation 12)
mean(post.Var_selgrad)
posterior.mode(as.mcmc(post.Var_selgrad))

# 95% credible interval of the variance
HPDinterval(as.mcmc(post.Var_selgrad))

# Visualise
par(mfrow=c(1,2))
plot(density(post.Var_selgrad))

# Two flavours of the estimate of the proportion of variance associated with the climate variables
# (Equation 12 in paper)
mean(post.Var_selgrad/(post.Var_selgrad+model_selgrad$VCV[,2])) # 0.6756869
posterior.mode(as.mcmc(post.Var_selgrad/(post.Var_selgrad+model_selgrad$VCV[,2]))) # 0.8413189

# 95% credible interval of the variance
HPDinterval(as.mcmc(post.Var_selgrad/(post.Var_selgrad+model_selgrad$VCV[,2])))

# visualise
plot(density(post.Var_selgrad/(post.Var_selgrad+model_selgrad$VCV[,2])))
```

Psterior mean vs posterior mode: This is something that Bayesians will argue about, with strong feelings and no real solution.  I don’t think these are differences that will massively influence your overall interpretation.  The posterior mode is most directly analogous to the maximum likelihood estimate.  In that sense it ought to be preferable.  However, the mean is used more often, I think mostly for practical reasons (there is typically less run-to-run variation in the value of the posterior mean than mode to to MCMC error).  Sorry that is not more helpful.

If you plot the posterior distributions (i.e. as a histogram or using the density() function) of your estimates of the proportions of variation explained by each variable individually, you’ll find that they are very skewed.  The values with the most posterior support are very small.  However, the distributions will indicate very high uncertainty, with quite large values of the proportion explained being compatible with the available data, such that the mean of the posterior distribution is higher.  Such are the frustrations with tackling hard and important questions that are extremely challenging analytically!

# Write table for further work

```{r write table with selected data (2411 flowering events) for further work}
write.table(data_sel,
             file="C:/Users/User/Dropbox/SU/Projects/lathyrus/lathyrus_ms1/data/clean/data_sel.csv",
             sep="\t",dec=",",col.names=T,row.names=F)
```
